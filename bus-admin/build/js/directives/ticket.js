angular.module("app.directives").directive("ticket",function($document){return{restrict:"A",replace:!0,templateUrl:"../../tpl/blocks/ticket.html",scope:{ticketInfo:"="},link:function(scope,element,attrs){function download(type){var imgdata=canvas.toDataURL(type),myBrowser=function(){var userAgent=navigator.userAgent;return userAgent.indexOf("OPR")>-1?"Opera":userAgent.indexOf("Firefox")>-1?"FF":userAgent.indexOf("Trident")>-1?"IE":userAgent.indexOf("Edge")>-1?"Edge":userAgent.indexOf("Chrome")>-1?"Chrome":userAgent.indexOf("Safari")>-1?"Safari":void 0},base64Img2Blob=function(code){for(var parts=code.split(";base64,"),contentType=parts[0].split(":")[1],raw=window.atob(parts[1]),rawLength=raw.length,uInt8Array=new Uint8Array(rawLength),i=0;i<rawLength;++i)uInt8Array[i]=raw.charCodeAt(i);return new Blob([uInt8Array],{type:contentType})};!function(data,filename){var link=document.createElement("a");link.href=data;var browser=myBrowser();if("IE"==browser||"Edge"==browser){var blob=base64Img2Blob(data);window.navigator.msSaveBlob(blob,filename)}else{link.download=filename;var event=document.createEvent("MouseEvents");event.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),link.dispatchEvent(event)}}(imgdata=imgdata.replace(function(type){return"image/"+(type=type.toLocaleLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]}(type),"image/octet-stream"),ticket.viewOrderid+"."+type)}var ticket={viewOrderid:scope.ticketInfo.viewOrderid,start:scope.ticketInfo.departName,end:scope.ticketInfo.arriveName,date:scope.ticketInfo.departDate,time:scope.ticketInfo.departTime,barcode:scope.ticketInfo.barcode,car:scope.ticketInfo.platenum,phone:scope.ticketInfo.sourcePhone},date=new Date(Number(ticket.date)),departDate=date.getFullYear()+" 年 "+(date.getMonth()+1)+" 月 "+date.getDate()+" 日 ",barcode=document.getElementById("barcodeCanvas");JsBarcode("#barcodeCanvas",ticket.barcode);var imgSrc=barcode.toDataURL(),img=new Image;img.crossOrigin="anonymous",img.src="../../img/ticket.png";var barcodeImg=new Image;barcodeImg.src=imgSrc;var canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");img.onload=function(){ctx.drawImage(img,0,0,700,1100),ctx.fillStyle="#0068B7",ctx.font="bold 40px Arial",ctx.fillText(ticket.start,140,156),ctx.fillText(ticket.end,140,256),ctx.font="26px Arial",ctx.fillText("车牌号：",70,360),ctx.fillText("出发时间：",70,410),ctx.fillText("发车地点：",70,460),ctx.fillText(ticket.car,230,360),ctx.fillText(departDate,230,410),ctx.fillText(ticket.time,500,410),ctx.fillText(ticket.start,230,460),ctx.font="20px Arial",ctx.fillStyle="#757575",ctx.fillText(ticket.phone,200,1032),ctx.drawImage(barcodeImg,100,620,500,200)},document.getElementById("btn1").onclick=function(){download("png")},scope.preview=function(){var dataUrl=canvas.toDataURL(),newImg=document.createElement("img");newImg.src=dataUrl;var printWindow=window.open(newImg.src);printWindow.document.write('<img src="'+newImg.src+'" id="ticket"/>'),setTimeout(function(){printWindow.print()},0)}}}});