angular.module("app.directives").directive("myCalendar",[function(){return{restrict:"A",replace:!0,templateUrl:"../../tpl/blocks/calender.html",scope:{changeDate:"=",selectDate:"&"},controller:function(){},link:function(scope){function getDateStr(date){var _year=date.getFullYear(),_month=date.getMonth()+1,_d=date.getDate();return _month=_month>9?""+_month:"0"+_month,_d=_d>9?""+_d:"0"+_d,_year+_month+_d}function showCalendarData(){var _year=dateObj.getDate().getFullYear(),_month=dateObj.getDate().getMonth()+1,_dateStr=getDateStr(dateObj.getDate()),currentDate=(dateObj.getDate().getDate(),new Date),currentDay=currentDate.getDate(),currenYear=currentDate.getFullYear(),currenMonth=currentDate.getMonth(),dateTime=new Date(currenYear,currenMonth,currentDay).getTime(),_tds=42,_firstDay=new Date(_year,_month-1,1);scope.titleStr=_dateStr.substr(0,4)+"年"+_dateStr.substr(4,2)+"月",scope.dateArr=[];for(var trArr=[],i=1;_tds>=i;i++){var _thisDay=new Date(_year,_month-1,i-_firstDay.getDay()),thisDate=(getDateStr(_thisDay),{date:_thisDay.getTime()});if(thisDate.date==dateTime?thisDate.className="current-day":thisDate.date<dateTime&&(thisDate.className="completed"),scope.changeDate&&scope.changeDate.length>0)for(var j=0,len=scope.changeDate.length;len>j;j++)thisDate.date==scope.changeDate[j]&&(thisDate.classNameChanged="changed");if(trArr.push(thisDate),i%7==0){var isCurrentMonth=isThisMonth(trArr,_month);isCurrentMonth&&(scope.dateArr.push(trArr),trArr=[])}}}function isThisMonth(arr,currenMonth){for(var len=arr.length,tmpFirst=new Date(arr[0].date),tmpLast=new Date(arr[len-1].date),monthFirst=tmpFirst.getMonth()+1,monthLast=tmpLast.getMonth()+1,m=0;len>m;m++){var monthDate=new Date(arr[m].date);monthDate.getMonth()+1!=currenMonth&&(arr[m].currentMonthClass="other-month")}return monthFirst==currenMonth||monthLast==currenMonth?!0:!1}var dateObj=function(){var _date=new Date;return{getDate:function(){return _date},setDate:function(date){_date=date}}}();scope.$watch("changeDate",function(){showCalendarData()}),scope.toPrevMonth=function(){var date=dateObj.getDate();dateObj.setDate(new Date(date.getFullYear(),date.getMonth()-1,1)),showCalendarData()},scope.toNextMonth=function(){var date=dateObj.getDate();dateObj.setDate(new Date(date.getFullYear(),date.getMonth()+1,1)),showCalendarData()},scope.click=function(date){scope.selectDate(date);for(var i=0;i<scope.dateArr.length;i++);}}}}]);