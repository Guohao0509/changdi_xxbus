app.controller("userListController",function($rootScope,$scope,$http,$state,$localStorage,$stateParams,$myHttpService,$tableListService){var options={searchFormId:"J_reg_form",listUrl:"api/user/queryUserListByKeword.htm"};$tableListService.init($scope,options),$tableListService.get(),$scope.useregtime={opened:!1,dateOptions:{datepickerMode:"day",showWeeks:!1,minMode:"day"},format:"yyyy-MM-dd",clear:function(){$scope.regDate=null},disabled:function(date,mode){return"day"===mode&&(0===date.getDay()||6===date.getDay())},toggleMin:function(){$scope.minDate=$scope.minDate?null:new Date},open:function($event){$event.preventDefault(),$event.stopPropagation(),$scope.useregtime.opened=!0}},$scope.restData=function(){$scope.userid="",$scope.regDate=""},$scope.delete=function(userid){layer.confirm("您确定要删除吗？",{icon:3,title:"提示"},function(){$myHttpService.post("api/user/deleteUserinfo",{userid:userid},function(){layer.msg("删除成功！",{offset:"100px"}),$state.go("app.user.user_list",{},{reload:!0})})},function(index){layer.close(index)})}}),app.controller("userEditController",["$scope","$myHttpService","$tableListService","$stateParams","$timeout","$state",function($scope,$myHttpService,$tableListService,$stateParams,$timeout,$state){if($scope.editMode=!!$stateParams.id,$scope.editMode){var options={searchFormId:"J_search_form",listUrl:"api/unit/queryUnitlistByKeyword",size:"9999",multiTable:"companyList",callback:function(){$myHttpService.post("api/user/queryUserinfo",{userid:$stateParams.id},function(data){$scope.user=data.user},function(){$timeout(function(){$state.go("app.user.user_list")},3e3)})}};$tableListService.init($scope,options),$tableListService.get(),$scope.submit=function(){var reqParam={userid:$stateParams.id,username:$scope.user.username,sex:$scope.user.sex,company:$scope.user.company,phone:$scope.user.phone};$scope.user.sex||(reqParam.sex="0"),console.log(reqParam),$myHttpService.post("api/user/updateUserinfo",reqParam,function(){layer.msg("编辑用户成功"),$state.go("app.user.user_list",{},{reload:!0})},function(){$timeout(function(){$state.go("app.user.user_list")},3e3)})}}else{var options={searchFormId:"J_search_form",size:"9999",listUrl:"api/unit/queryUnitlistByKeyword",multiTable:"companyList"};$tableListService.init($scope,options),$tableListService.get(),$scope.submit=function(){var reqParam={users:[{username:$scope.user.username,company:$scope.user.company,phone:$scope.user.phone}]};angular.forEach(reqParam.users,function(ele){ele.sex||(ele.sex="0")}),$myHttpService.post("api/user/insertUserInfoList",{data:JSON.stringify(reqParam)},function(){layer.msg("添加用户成功"),$state.go("app.user.user_list",{},{reload:!0})},function(){$timeout(function(){$state.go("app.user.user_list")},3e3)})}}}]),app.controller("usersAddController",["$scope","$myHttpService","$tableListService","$timeout","$state",function($scope,$myHttpService,$tableListService,$timeout,$state){$scope.users={},$scope.usersData=[];var options={searchFormId:"J_search_form",listUrl:"api/unit/queryUnitlistByKeyword",size:"9999",multiTable:"companyList"};$tableListService.init($scope,options),$tableListService.get(),$scope.$watch("users.company",function(newVal){$scope.companyList&&(angular.forEach($scope.companyList.units,function(item){newVal==item.unitid&&($scope.companyName=item.unitName)}),$scope.usersData.length>0&&$scope.updateCompany())}),$scope.json=function(data){if(data.splice(0,1),$scope.haveErr=!1,$scope.usersData=[],usersForm.reset(),"0"==$scope.users.company)return layer.msg("请先选择运营单位"),void $scope.reset();for(var reg=/^1[3|5|7|8]\d{9}$/,i=0;i<data.length;i++){var tmpObj={};tmpObj.company=$scope.users.company,tmpObj.phone=data[i].phone,tmpObj.username=data[i].username,"男"==data[i].sex?tmpObj.sex="0":"女"==data[i].sex?tmpObj.sex="1":(tmpObj.error=!0,$scope.haveErr=!0),reg.test(data[i].phone)||(tmpObj.error=!0,$scope.haveErr=!0),$scope.usersData.push(tmpObj)}$scope.$apply()},$scope.updateCompany=function(){for(var i=0;i<$scope.usersData.length;i++)$scope.usersData[i].company=$scope.users.company},$scope.reset=function(){usersForm.reset(),$scope.usersData=[],$scope.users={company:"0"}},$scope.submit=function(){if($scope.usersData.length<=0||$scope.haveErr)return void layer.msg("您上传的表格数据有误，请修改后重新上传");$scope.submiting=!0;var reqParam={users:$scope.usersData};$myHttpService.post("api/user/insertUserInfoList",{data:JSON.stringify(reqParam)},function(){layer.msg("添加用户成功"),$scope.submiting=!1},function(){$timeout(function(){$state.go("app.user.user_list")},3e3)})}}]);