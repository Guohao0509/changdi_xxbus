var app=angular.module("app");app.controller("AppController",function(e,t,o,r,n){e.routerInclude=function(e){return t.currState=o,-1!=t.currState.current.name.indexOf(e)},t.changePage=function(e){n.path(e).replace()}}),app.controller("LoginController",function(e,t,o,r,n,s,a){r.url&&(t.showTip=!0,t.tips="请先验证您的手机号"),t.user={},t.first=!0,t.sendButtonText="重新获取",t.sendStatus=!0,t.sendCode=function(){s.post("api/user/queryUserByPhone",{phone:t.user.mobile},function(e){console.log(e)})}}).controller("SelectLocationController",function(e,t,o,r,n){var s=o.params.params,a=null,i=o.params.status;t.address=e[s],t.poilist=[],t.address?r.getPoisByKeyword(t.address.name,function(e){for(var o=[],r=0,s=e.length;r<s;r++)void 0!=e[r].location&&""!=e[r].location&&o.push(e[r]);n.scrollTo(0,0,!0),t.poilist=o,t.poilist.length>0&&(t.poilist[0].active=!0),t.$apply()}):r.getCurrentPosition(function(o){o.length>0&&(a.setCenter(o[0].location),t.poilist=o,t.poilist.length>0&&(t.poilist[0].active=!0,t.address={name:t.poilist[0].name,lngLat:t.poilist[0].location.getLng()+","+t.poilist[0].location.getLat()}),t.$apply(),1==i&&(e[s]=t.address))});a=new AMap.Map("J_map_canvas",{zoom:17,animateEnable:!1,center:void 0==t.address?[0,0]:t.address.lngLat.split(",")});AMap.plugin(["AMap.ToolBar"],function(){a.addControl(new AMap.ToolBar)}),AMap.event.addListener(a,"dragend",function(){r.getPoisByLngLat(a.getCenter(),function(e){t.poilist=e,t.poilist.length>0&&(t.poilist[0].active=!0,t.address={name:t.poilist[0].name,lngLat:t.poilist[0].location.getLng()+","+t.poilist[0].location.getLat()}),n.scrollTo(0,0,!0),t.$apply()})}),t.cancel=function(){window.history.back(-1)},t.active=function(e,o){for(var r=0,n=t.poilist.length;r<n;r++)o==r?(t.poilist[r].active=!0,t.address={name:e.name,lngLat:e.location.getLng()+","+e.location.getLat()}):t.poilist[r].active=!1;a.setCenter(e.location)},t.save=function(){e[s]=t.address,window.history.back(-1)},t.openSelectAddress=function(){o.go("select_address",{params:s})}}).controller("SelectAddressController",function(e,t,o,r,n){var s=o.params.params;t.keyword={text:""},t.poilist=[],t.search=function(){r.getPoisByKeyword(t.keyword.text,function(e){for(var o=[],r=0,s=e.length;r<s;r++)void 0!=e[r].location&&""!=e[r].location&&o.push(e[r]);n.scrollTo(0,0,!0),t.poilist=o,t.$apply()})},t.cancel=function(){window.history.back(-1)},t.active=function(t){e[s]={name:t.name,address:t.address,lngLat:t.location.getLng()+","+t.location.getLat()},window.setTimeout(function(){window.history.back(-1)},0)}}).controller("CreateRouteController",function(e,t,o,r,n,s){if(t.schedule={onDutyTitle:"上班时间",onDutyTime:new Date(2001,0,1,9,0,0),offDutyTitle:"下班时间",offDutyTime:new Date(2001,0,1,18,0,0)},e.departAddressCreate){a=e.departAddressCreate;t.schedule.depart=a.name,t.schedule.departLngLat=a.lngLat}else r.getCurrentPosition(function(o){if(o.length>0){var o=o[0];e.departAddressCreate={name:o.name,lngLat:o.location.lng+","+o.location.lat},t.schedule.depart=o.name,t.schedule.departLngLat=o.location.lng+","+o.location.lat,t.$apply()}else t.schedule.depart="无法获取你的位置",t.schedule.departLngLat="0,0",t.$apply()});if(e.arriveAddressCreate){var a=e.arriveAddressCreate;t.schedule.arrive=a.name,t.schedule.arriveLngLat=a.lngLat,console.log(t.schedule.arrive)}t.selectLocation=function(e,t){o.go("select_location",{params:e,status:t})},t.save=function(){var o={phone:e.session.user.userInfo.phone,getonaddr:t.schedule.depart,getonlgt:t.schedule.departLngLat.split(",")[0],getonlat:t.schedule.departLngLat.split(",")[1],getoffaddr:t.schedule.arrive,getofflgt:t.schedule.arriveLngLat.split(",")[0],getofflat:t.schedule.arriveLngLat.split(",")[1],startworktime:t.schedule.onDutyTime.getTime(),endworktime:t.schedule.offDutyTime.getTime()};s.post("api/applyBusline/applyBusline",o,function(){n.path("/create_route_success").replace()})},t.exchangePosition=function(){var o=t.schedule.depart,r=t.schedule.departLngLat;t.schedule.depart=t.schedule.arrive,t.schedule.departLngLat=t.schedule.arriveLngLat,t.schedule.arrive=o,t.schedule.arriveLngLat=r,e.departAddressCreate={name:t.schedule.depart,lngLat:t.schedule.departLngLat},e.arriveAddressCreate={name:t.schedule.arrive,lngLat:t.schedule.arriveLngLat}}}).controller("ScheduleWillOpenController",function(e,t,o,r,n){t.scheduleList=[],t.offset=0,t.pagesize=20,t.totalnum=0,t.showMoreBtn=!1,t.getData=function(){r.post("api/busline/queryCycleBuslines",{runstatus:0,offset:t.offset,pagesize:t.pagesize},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.scheduleList=e.cycleBuslineSchedules,window.setTimeout(function(){n.resize()},0)})},t.getData(),t.refresh=function(){t.offset=0,r.postNoLoad("api/busline/queryCycleBuslines",{runstatus:0,offset:t.offset,pagesize:t.pagesize},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.scheduleList=e.cycleBuslineSchedules,window.setTimeout(function(){n.resize()},0),layer.msg("刷新成功")})},t.goToScheduleDetail=function(e){o.go("schedule.detail",{bsid:e.bsid,mode:1})},t.getMoreData=function(){t.offset=t.offset+t.pagesize,r.post("api/busline/queryCycleBuslines",{runstatus:0,offset:t.offset,pagesize:t.pagesize},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.scheduleList=t.scheduleList.concat(e.cycleBuslineSchedules),window.setTimeout(function(){n.resize()},0)})}}).controller("ScheduleOpenedController",function(e,t,o,r,n){t.scheduleList=[],t.offset=0,t.pagesize=20,t.totalnum=0,t.showMoreBtn=!1,t.getData=function(){r.post("api/busline/queryCycleBuslines",{offset:t.offset,pagesize:t.pagesize,company:"2017092210022499480058"},function(e){console.log("关于已开通路线:"+JSON.stringify(e)),t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.scheduleList=e.cycleBuslineSchedules,window.setTimeout(function(){n.resize()},0)})},t.getData(),t.refresh=function(){t.offset=0,r.postNoLoad("api/busline/queryCycleBuslines",{offset:t.offset,pagesize:t.pagesize,company:"2017092210022499480058"},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.scheduleList=e.cycleBuslineSchedules,window.setTimeout(function(){n.resize()},0),layer.msg("刷新成功")})},t.goToScheduleDetail=function(e){var t={bsid:e.bsid};o.go("schedule.detail",{stopStationobj:JSON.stringify(t)})},t.getMoreData=function(){t.offset=t.offset+t.pagesize,r.post("api/busline/queryCycleBuslines",{runstatus:1,offset:t.offset,pagesize:t.pagesize},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.scheduleList=t.scheduleList.concat(e.cycleBuslineSchedules),window.setTimeout(function(){n.resize()},0)})}}).controller("SignUpSuccessController",function(e,t,o,r,n){var s={};e.tipStatus=!1,n.post("api/utils/getWechatJsSign",{currenturl:window.location.href.split("#")[0]},function(e){s={debug:!1,appId:e.appId,timestamp:e.timestamp,nonceStr:e.nonceStr,signature:e.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]},wx.config(s),wx.ready(function(){})}),e.share=function(){e.tipStatus=!0}}).controller("TicketMonthController",function(e,t,o){t.scheduleList=[],t.requestStatus=!1,o.post("api/ticket/queryTicketsList",{userid:e.session.user.userInfo.userid},function(e){t.requestStatus=!0,t.scheduleList=e.tickets})}).controller("IUserController",function(e,t,o,r,n){t.user={},t.tempUser={},n.post("api/user/queryUserinfo",{userid:e.session.user.userInfo.userid},function(e){t.user=e.user}),t.editMode=!1,t.editButtonText="编辑",t.edit=function(){0==t.editMode?(t.tempUser=t.user,t.editMode=!t.editMode,t.editButtonText="保存"):(t.editMode=!t.editMode,t.editButtonText="编辑",n.post("api/user/modifyUserInfo",t.tempUser,function(e){t.user=t.tempUser,layer.msg("修改成功")}))}}).controller("TicketStoreController",function(e,t,o,r){t.cardInfo={barcode:0x1b69b4ba630f350,refreshTime:15,refreshStatus:!0},r.post("api/user/queryUserBarcode",{userid:e.session.user.userInfo.userid},function(e){t.cardInfo.balance=e.user.balance,t.cardInfo.barcode=e.user.barcode,t.cardInfo.refreshStatus=!1}),o(function(){t.cardInfo.refreshTime--,0==t.cardInfo.refreshTime&&0==t.cardInfo.refreshStatus&&(t.cardInfo.refreshStatus=!0,r.postNoLoad("api/user/queryUserBarcode",{userid:e.session.user.userInfo.userid},function(e){t.cardInfo.balance=e.user.balance,t.cardInfo.barcode=e.user.barcode,t.cardInfo.refreshStatus=!1,t.cardInfo.refreshTime=15}))},1e3)}).controller("TicketDetailController",function(e,t,o,r,n){t.ticket={},t.barcode=0,t.requestStatus=!1,t.cardInfo={refreshTime:9e3,refreshStatus:!0},r.post("api/ticket/queryTicketInfo",{ticketid:n.ticketid},function(e){t.requestStatus=!0,t.ticket=e.ticket,t.barcode=e.barcode,t.cardInfo.refreshStatus=!1,t.ticket.startDate=new Date(e.ticket.startdate),t.ticket.endDate=new Date(e.ticket.enddate),t.tickettype=e.tickettype}),o(function(){n.ticketid&&(t.cardInfo.refreshTime--,0==t.cardInfo.refreshTime&&0==t.cardInfo.refreshStatus&&(t.cardInfo.refreshStatus=!0,r.postNoLoad("api/ticket/queryTicketInfo",{ticketid:n.ticketid},function(e){t.ticket=e.ticket,t.barcode=e.barcode,t.ticket.startDate=new Date(e.ticket.startdate),t.ticket.endDate=new Date(e.ticket.enddate),t.cardInfo.refreshStatus=!1,t.cardInfo.refreshTime=9e3})))},1e3)}).controller("PayOrderListController",function(e,t,o,r){t.offset=0,t.pagesize=5,t.showMoreBtn=!1,t.orderList=[],o.post("api/recharge/queryRechargeOrders",{userid:e.session.user.userInfo.userid,offset:t.offset,pagesize:t.pagesize},function(e){e.rechargeOrders.length-t.pagesize==0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.orderList=e.rechargeOrders}),t.getMoreData=function(){t.offset=t.offset+t.pagesize,o.post("api/recharge/queryRechargeOrders",{userid:e.session.user.userInfo.userid,offset:t.offset,pagesize:t.pagesize},function(e){e.rechargeOrders.length-t.pagesize==0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.orderList=t.orderList.concat(e.rechargeOrders),r.resize()})},t.refresh=function(){t.offset=0,o.postNoLoad("api/recharge/queryRechargeOrders",{userid:e.session.user.userInfo.userid,offset:t.offset,pagesize:t.pagesize},function(e){e.rechargeOrders.length-t.pagesize==0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.orderList=e.rechargeOrders,layer.msg("刷新成功")})}}).controller("TicketRechargeController",function(e,t,o,r){t.user={rechargeNum:""},t.recharge=function(){o.post("api/recharge/rebillUserBalance",{userid:e.session.user.userInfo.userid,openid:e.session.user.userInfo.openid,chargefee:t.user.rechargeNum},function(e){function n(){WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(n){"get_brand_wcpay_request:ok"==n.err_msg?o.post("api/recharge/verifyWxorderStatus",{rechargeid:e.rechargeid},function(e){alert("您本次成功充值了"+t.user.rechargeNum+"元"),r.url("/ticket/store").replace()},function(e){alert("支付失败，请联系客服处理。")}):"get_brand_wcpay_request:cancel"==n.err_msg?alert("你取消了本次支付"):alert("支付失败，请联系客服处理。")})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",n,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",n),document.attachEvent("onWeixinJSBridgeReady",n)):n()})}}).controller("ScheduleTicketPaySuccess",function(e,t,o,r,n){t.orderInfoList=JSON.parse(n.orderList),t.showTicket=function(){o.url("/ticket/month").replace()}}).controller("TicketRecharge2Controller",function(e,t,o,r,n,s){t.rechargeCouponList=[],t.agreeStatus=!0,t.agreeStatusChange=function(){t.agreeStatus=!t.agreeStatus},t.orderInfo={rcid:"",payType:0,payMoney:0,couponMoney:0};var a=0;n.post("api/rechargeCoupon/queryRechargeCouponList",{offset:0,pagesize:10},function(e){t.rechargeCouponList=e.rechargeCoupons,e.rechargeCoupons.length>0&&(t.orderInfo={rcid:e.rechargeCoupons[0].rcid,payMoney:e.rechargeCoupons[0].paymoney,couponMoney:e.rechargeCoupons[0].couponMoney,rechargeMoney:e.rechargeCoupons[0].rechargeMoney,hasCoupon:e.rechargeCoupons[0].hascoupon,isActive:e.rechargeCoupons[0].isactive,payType:0},t.rechargeCouponList[0].active=!0)}),t.changeCoupon=function(e,o){t.rechargeCouponList[a].active=!1,e.active=!0,a=o,t.orderInfo={rcid:e.rcid,payMoney:e.paymoney,couponMoney:e.couponMoney,rechargeMoney:e.rechargeMoney,hasCoupon:e.hascoupon,isActive:e.isactive,payType:0}},t.recharge=function(){n.post("api/recharge/rebillUserBalanceCoupon",{userid:e.session.user.userInfo.userid,openid:e.session.user.openId,rcid:t.orderInfo.rcid},function(e){function o(){WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(o){"get_brand_wcpay_request:ok"==o.err_msg?n.post("api/recharge/verifyWxorderStatus",{rechargeid:e.rechargeid},function(e){alert("您本次成功充值了"+t.orderInfo.rechargeMoney+"元"),s.url("/ticket/store").replace()},function(e){alert("支付失败，请联系客服处理。")}):"get_brand_wcpay_request:cancel"==o.err_msg?alert("你取消了本次支付"):alert("支付失败，请联系客服处理。")})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",o,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",o),document.attachEvent("onWeixinJSBridgeReady",o)):o()})}}).controller("BusPositionController",["$scope",function(e){var t=[],o=new AMap.Map("J_map_canvas",{resizeEnable:!0,center:[116.397428,39.90923],zoom:17});marker=new AMap.Marker({map:o,position:[116.397428,39.90923],icon:"http://webapi.amap.com/images/car.png",offset:new AMap.Pixel(-26,-13),autoRotation:!0});var r=116.397428,n=39.90923;t.push([r,n]);for(var s=1;s<4;s++)r+=.05*Math.random(),n+=s%2?1e-4*Math.random():.06*Math.random(),t.push([r,n]);new AMap.Polyline({map:o,path:t,strokeOpacity:0});marker.moveAlong(t,500),marker.pauseMove(),marker.resumeMove()}]);