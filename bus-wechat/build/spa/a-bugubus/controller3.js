var app=angular.module("app");app.controller("AppController",function(e,t,o,n,s){e.routerInclude=function(e){return t.currState=o,-1!=t.currState.current.name.indexOf(e)},t.changePage=function(e){s.path(e).replace()}}),app.controller("LoginController",function(e,t,o,n,s,a,i){a.post("api/unit/queryUnitNameList",{},function(e){t.companys=e.units,console.log(e.units)},function(e){console.log(e)}),n.url&&(t.showTip=!0,t.tips="请先验证您的手机号"),t.user={},t.first=!0,t.sendButtonText="重新获取",t.sendStatus=!0,t.sendCode=function(){nextLogin=function(e){var o=t.user.mobile%t.user.mobile.toString().substr(1,3);a.post("api/utils/sendAuthcode",{phone:t.user.mobile,servicename:"WechatUserLogin",checkcode:o},function(e){layer.msg("短信验证码发送成功！"),t.first=!1,t.sendStatus=!1;var o=60;t.sendButtonText=o+"s后获取";var n=window.setInterval(function(){o>0?(o--,t.sendButtonText=o+"s后获取",t.$apply()):(t.sendStatus=!0,t.sendButtonText="重新获取",t.$apply(),window.clearInterval(n))},1e3)})},nextLogin()},t.next=function(){0!=t.user.selectedComp?a.post("auth/login",{phone:t.user.mobile,authcode:t.user.authcode,openid:e.session.user.openId,company:t.user.selectedComp},function(t){e.session.user.userInfo=t.user,n.url?i.url(n.url).replace():i.url("/app/buy").replace()}):layer.msg("请选择您所在的公司")}}),app.controller("IUserController",function(e,t,o,n,s){t.user={},t.tempUser={},s.post("api/user/queryUserinfo",{userid:e.session.user.userInfo.userid},function(e){t.user=e.user}),t.editMode=!1,t.editButtonText="编辑",t.edit=function(){0==t.editMode?(t.tempUser=t.user,t.editMode=!t.editMode,t.editButtonText="保存"):(t.editMode=!t.editMode,t.editButtonText="编辑",s.post("api/user/modifyUserInfo",t.tempUser,function(e){t.user=t.tempUser,layer.msg("修改成功")}))}}),app.controller("ScheduleDetailController",function(e,t,o,n,s,a,i,r,u,d){n.$on("$destroy",function(){console.log("distory map")}),n.mode=s.mode;var l=null,p=null;n.goSchedule={},n.goLine={},n.backLine={},n.stopStationobj=JSON.parse(s.stopStationobj),n.init=function(){for(var e=0,t=parseInt(n.stopStationobj.startIndex)+1;t<=n.stopStationobj.endIndex;t++)e+=n.stopStationobj.stopstation[t].price;n.addprice=e;for(var o=0,s=parseInt(n.stopStationobj.startIndex)+1;s<=n.stopStationobj.endIndex;s++)o+=n.stopStationobj.stopstation[s].driverTime;n.addtime=o},n.init();var c=function(){u.postNoLoad("api/busline/queryCarLocation",{carid:n.busSchedule.carid},function(e){S?(console.log("ser Marker"),b.setPosition([e.car.currlon,e.car.currlat])):(S=!0,console.log("marker不存在, new marker"),b=new AMap.Marker({map:l,position:[e.car.currlon,e.car.currlat],content:m,draggable:!1}))})};n.expandStatus=!1;var f={clearMap:function(){l.clearMap()},addMarkers:function(e){for(var t=0,o=e.length;t<o;t++){var n;if(0==t)n="http://webapi.amap.com/theme/v1.3/markers/n/start.png";else if(t==o-1)n="http://webapi.amap.com/theme/v1.3/markers/n/end.png";else{if(1!=e[t].stationType)continue;n="http://webapi.amap.com/theme/v1.3/markers/n/mid.png"}new AMap.Marker({map:l,position:new AMap.LngLat(e[t].stalongitude,e[t].stalatitude),icon:n,extData:e[t],draggable:!1})}},addPolyline:function(e){(e=new AMap.Polyline({path:e,strokeColor:"#1BAC2E",strokeOpacity:1,strokeWeight:6,strokeStyle:"solid",strokeDasharray:[10,5],isOutline:!0,outlineColor:"#fff",borderWeight:1.5,lineJoin:"round",showDir:!0})).setMap(l),l.setFitView()},drivingSearch:function(e){r.show();var t=e.length;if(t>1){for(var o=new AMap.LngLat(e[0].stalongitude,e[0].stalatitude),n=new AMap.LngLat(e[t-1].stalongitude,e[t-1].stalatitude),s=[],a=1;a<t-1;a++)s.push(new AMap.LngLat(e[a].stalongitude,e[a].stalatitude));p.search(o,n,{waypoints:s},function(){r.hide(),l.setFitView()})}else alert("读取线路数据出错")}};r.show(),u.post("api/busline/queryCycleBusScheduleInfo",{bsid:n.stopStationobj.bsid},function(e){n.busSchedule=e.busSchedule,n.busStations=e.busStations,l=new AMap.Map("J_map_canvas",{zoom:14,animateEnable:!1,jogEnable:!1,center:[114.530266,30.498785]}),AMap.plugin(["AMap.ToolBar"],function(){l.addControl(new AMap.ToolBar({offset:new AMap.Pixel(10,150)}))}),p=new AMap.Driving({map:l,hideMarkers:!0}),console.log(n.busStations),f.addMarkers(n.busStations),n.busSchedule.buslineTrail?f.addPolyline(JSON.parse(n.busSchedule.buslineTrail)):f.drivingSearch(n.busStations),c(),d(c,5e3)});var b,m="<div class='bus-image marker'></div>",S=!1;n.baoming=function(){if(void 0==o.session.user.userInfo){var e=encodeURIComponent("/schedule/detail?bsid="+n.stopStationobj.bsid+"&mode=1");a.url("/auth/login?url="+e)}else u.post("api/userEnrollBusline/userEnrollBusline",{userid:o.session.user.userInfo.userid,phone:o.session.user.userInfo.phone,lineid:n.busSchedule.lineid,bsid:n.busSchedule.bsid},function(e){a.url("/signup_success?bsid="+n.stopStationobj.bsid)})},n.oldIndex=0,n.oldIndexs=0,n.expand=function(){n.expandStatus=!n.expandStatus,1==n.expandStatus?l.panBy(0,140):l.panBy(0,-140)},n.RideactiveStations=function(e){n.busStations[n.oldIndex].active=!1,n.busStations[e].active=!0,n.oldIndex=e,l.setZoom(18),l.setCenter([n.busStations[e].stalongitude,n.busStations[e].stalatitude]),l.panBy(0,140)},n.$watch("stopStationobj.startIndex",function(e,t){(n.stopStationobj.startIndex==n.stopStationobj.endIndex||n.stopStationobj.startIndex>n.stopStationobj.endIndex)&&(n.stopStationobj.startIndex=t,n.init())}),n.$watch("stopStationobj.endIndex",function(e,t){(n.stopStationobj.startIndex==n.stopStationobj.endIndex||n.stopStationobj.startIndex>n.stopStationobj.endIndex)&&(n.stopStationobj.endIndex=t,n.init())}),n.selectstartadd=function(){n.stopStationobj.stopstation[n.stopStationobj.startIndex];n.stopStationobj.startIndex>n.stopStationobj.endIndex?layer.msg("起始位置不能超过终点位置"):n.stopStationobj.startIndex==n.stopStationobj.endIndex&&layer.msg("选择的地点信息不能相同"),n.init()},n.selectendadd=function(){n.stopStationobj.stopstation[n.stopStationobj.endIndex],parseInt(n.stopStationobj.endIndex);n.stopStationobj.startIndex>n.stopStationobj.endIndex?layer.msg("终点位置不能早于起始位置"):n.stopStationobj.startIndex==n.stopStationobj.endIndex&&layer.msg("选择的地点信息不能相同"),n.init()},n.showLocation=function(e){var t=e.stalongitude+","+e.stalatitude,o=e.stationname;window.location.href="http://m.amap.com/navi/?start=&dest="+t+"&destName="+o+"&naviBy=bus&key=1a5cdec55ebac9dbd85652429f54d4d1"}}),app.controller("ScheduleOpenedController",function(e,t,o,n,s){t.scheduleList=[],t.offset=0,t.pagesize=20,t.totalnum=0,t.showMoreBtn=!1,t.getData=function(){n.post("api/busline/queryCycleBuslines",{offset:t.offset,pagesize:t.pagesize,company:window.global.config.user.userInfo.company,userid:e.session.user.userInfo.userid},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.scheduleList=e.cycleBuslineSchedules,window.setTimeout(function(){s.resize()},0)})},t.getData(),t.refresh=function(){t.offset=0,n.postNoLoad("api/busline/queryCycleBuslines",{offset:t.offset,pagesize:t.pagesize,company:window.global.config.user.userInfo.company,userid:e.session.user.userInfo.userid},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.$broadcast("scroll.refreshComplete"),t.scheduleList=e.cycleBuslineSchedules,window.setTimeout(function(){s.resize()},0),layer.msg("刷新成功")})},t.goToScheduleDetail=function(e){var t={bsid:e.bsid};o.go("schedule.detail",{stopStationobj:JSON.stringify(t)})},t.getMoreData=function(){t.offset=t.offset+t.pagesize,n.post("api/busline/queryCycleBuslines",{runstatus:1,offset:t.offset,pagesize:t.pagesize},function(e){t.totalnum=e.totalnum,t.totalnum-(t.offset+t.pagesize)>0?t.showMoreBtn=!0:t.showMoreBtn=!1,t.scheduleList=t.scheduleList.concat(e.cycleBuslineSchedules),window.setTimeout(function(){s.resize()},0)})}});