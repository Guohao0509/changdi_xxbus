!function(){"use strict";angular.module("app").service("timePickerService",function(){var e=this;return e.globalId=0,e.format=function(e,t){var i={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in i)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[a]:("00"+i[a]).substr((""+i[a]).length)));return t},e}).directive("timePicker",["$timeout","$compile","$ionicScrollDelegate","$ionicBackdrop","$q","timePickerService",function(e,t,i,a,l,n){return{template:"<div>{{selectDateTime.show}}</div>",restrict:"AE",replace:!0,scope:{format:"@",okHandler:"&",timePickerResult:"=",loadDateTime:"="},link:function(l,o,s){function r(e){e.hideYear||c(e),e.hideMoth||m(e),e.hideDate||d(e),e.hideTime||h(e),H=angular.element(H),t(H)(l),angular.element(document.body).append(H),L(),v()}function c(e){l.yearScroll=i.$getByHandle("yearScroll_"+w);var t,a,n,o,s,r=e.DateTime.getFullYear(),c=e.yearEnd-e.yearStart;T(l.yearList,3,"b");for(var m=0;m<=c;m++)t=e.yearStart+m,a=e.yearStart+m,n=p(0,e.height+l.yearList[l.yearList.length-1].top,a,a==r,t),a==r&&(o=n,s=l.yearList.length),l.yearList.push(n);l.selectDateTime.year.item=o,l.selectDateTime.year.index=s,T(l.yearList,3,"e")}function m(e){l.monthScroll=i.$getByHandle("monthScroll_"+w);var t,a,n,o,s,r=e.DateTime.getMonth()+1==0?12:g(e.DateTime.getMonth()+1,10);T(l.monthList,3,"b");for(var c=1;c<=12;c++)c,a=g(c,10),t=g(c,10)+"月",n=p(0,e.height+l.monthList[l.monthList.length-1].top,a,a==r,t),a==r&&(o=n,s=l.monthList.length),l.monthList.push(n);l.selectDateTime.month.item=o,l.selectDateTime.month.index=s,T(l.monthList,3,"e")}function d(e){l.dateScroll=i.$getByHandle("dateScroll_"+w);var t,a,n,o,s,r=g(e.DateTime.getDate(),10),c=S(e.DateTime.getFullYear(),e.DateTime.getMonth()+1);T(l.dateList,3,"b");for(var m=1;m<=c;m++)a=g(m,10),t=g(m,10)+"日",n=p(0,e.height+l.dateList[l.dateList.length-1].top,a,a==r,t),a==r&&(o=n,s=l.dateList.length),l.dateList.push(n);l.selectDateTime.date.item=o,l.selectDateTime.date.index=s,T(l.dateList,3,"e")}function h(e){l.timeScroll=i.$getByHandle("timeScroll_"+w),console.log(e);var t,a,n=u(e);T(l.timeList,3,"b");for(var o=e.DateTime.getHours(),s=0;s<e.timeNum;s++){var r=o+s;r>=24?r=g(r-=24,10):r<10&&(r=g(r,10));for(var c=0;c<60/e.timeSpan;c++){var m=e.height+l.timeList[l.timeList.length-1].top,d=r+":"+(c*e.timeSpan==0?"00":c*e.timeSpan),h=p(0,m,d,d==n,d);l.timeList.push(h),d==n&&(t=h,a=l.timeList.length)}}T(l.timeList,3,"e"),l.selectDateTime.time.item=t,l.selectDateTime.time.index=a-1}function u(e){var t,i;if(e.minuteSkip||parseInt(e.DateTime.getMinutes()/e.timeSpan)!=e.DateTime.getMinutes()/e.timeSpan){e.minuteSkip=e.minuteSkip||30;var a=new Date;t=a.getHours(),i=a.getMinutes();var l,n=(i+=e.minuteSkip)-60;switch(n>=0?(t+=1,l=Math.round(Math.abs(n)/e.timeSpan)):l=Math.round(i/e.timeSpan),l){case 1:i=e.timeSpan;break;case 2:i=2*e.timeSpan;break;case 3:i=3*e.timeSpan;break;case 4:t+=1,i=0;default:i=0}}else t=e.DateTime.getHours(),i=e.DateTime.getMinutes();return g(t,10)+":"+g(i,10)}function g(e,t){return e>=t?e:"0"+e}function p(e,t,i,a,l){return{left:e,top:t,data:i,selected:a,text:l}}function T(e,t,i){switch(i=i||"b"){case"b":for(var a=0;a<t;a++)e.push(p(0,I.height*a,"",!1,""));break;case"e":for(var l=e[e.length-1].top,n=0;n<t;n++)e.push(p(0,I.height*(a+1)+l,"",!1,""))}}function f(e,t){e.scrollTo(t.left,t.top,!0)}function D(e,t){e.scrollTo(t.left,t.top,!0)}function y(t,i){switch(i){case"year":e(function(){l.selectDateTime.year.item.selected=!1,l.yearList[t].selected=!0,l.selectDateTime.year.item=l.yearList[t],l.selectDateTime.year.index=t,b(l.selectDateTime.year.item.data,parseInt(l.selectDateTime.month.item.data))});break;case"month":e(function(){l.selectDateTime.month.item.selected=!1,l.monthList[t].selected=!0,l.selectDateTime.month.item=l.monthList[t],l.selectDateTime.month.index=t,b(l.selectDateTime.year.item.data,parseInt(l.selectDateTime.month.item.data))});break;case"date":e(function(){l.selectDateTime.date.item.selected=!1,l.dateList[t].selected=!0,l.selectDateTime.date.item=l.dateList[t],l.selectDateTime.date.index=t});break;case"time":e(function(){l.selectDateTime.time.item.selected=!1,l.timeList[t].selected=!0,l.selectDateTime.time.item=l.timeList[t],l.selectDateTime.time.index=t})}}function v(){l.selectDateTime.show=(l.options.hideYear?"":l.selectDateTime.year.item.text+" ")+(l.options.hideMoth?"":l.selectDateTime.month.item.text)+(l.options.hideDate?"":l.selectDateTime.date.item.text+" ")+(l.options.hideTime?"":l.selectDateTime.time.item.text)}function L(){var e=(l.options.hideYear?"":l.selectDateTime.year.item.data+"-")+(l.options.hideMoth?"":l.selectDateTime.month.item.data+"-")+(l.options.hideDate?"":l.selectDateTime.date.item.data+" ")+(l.options.hideTime?"":l.selectDateTime.time.item.data);return l.timePickerResult=l.format?n.format(new Date(e),l.format):e,l.timePickerResult}function S(e,t){var i=30;return l.specialDateTime.isBigMonth(t)?i++:l.specialDateTime.isLoopYear(e)?2==t&&i--:2==t&&(i-=2),i}function b(e,t){var i=S(e,t);if(i!=l.dateList.length-6){var a,n,o,s=i-(l.dateList.length-6);if(s>0)for(var r=l.dateList[l.dateList.length-4],c=1;c<=s;c++)a=(n=r.data+c)+"日",o=p(0,I.height+l.dateList[l.dateList.length-4].top,n,!1,a),l.dateList.splice(l.dateList.length-3,0,o);else{var m=Math.abs(s);l.dateList.splice(l.dateList.length-4-m+1,m),l.selectDateTime.date.item.data>l.dateList[l.dateList.length-4].data&&(l.dateList[l.dateList.length-4].selected=!0,l.selectDateTime.date.item=l.dateList[l.dateList.length-4],l.selectDateTime.date.item.index=l.dateList.length-4,f(l.dateScroll,l.dateList[l.selectDateTime.date.index-3]))}}}function k(e){var t=new Object;switch(e){case"year":t.scrollTimer="yearScrollTimer",t.type=e,t.scrollHandler="yearScroll",t.data="yearList",t.defaultSelected=l.selectDateTime.year.item.data,t.selectedItem="year";break;case"month":t.scrollTimer="monthScrollTimer",t.type=e,t.scrollHandler="monthScroll",t.data="monthList",t.defaultSelected=l.selectDateTime.month.item.data,t.selectedItem="month";break;case"date":t.scrollTimer="dateScrollTimer",t.type=e,t.scrollHandler="dateScroll",t.data="dateList",t.defaultSelected=l.selectDateTime.date.item.data,t.selectedItem="date";break;case"time":t.scrollTimer="timeScrollTimer",t.type=e,t.scrollHandler="timeScroll",t.data="timeList",t.defaultSelected=l.selectDateTime.time.item.data,t.selectedItem="time"}return t}function x(){l.options.inModal&&angular.element(document.body).removeClass("modal-open"),a.retain(),H.css("display","block")}function M(){l.options.inModal&&angular.element(document.body).addClass("modal-open"),H.css("display","none"),a.release()}function $(){H.remove()}var w=++n.globalId,E=new Date,H="<div class='pickerContainer datetimeactive'><div class='main'><div  class='header'><div>{{options.title}}</div></div><div class='body'><div class='row row-no-padding'><div class='col'  ng-if='!options.hideYear' ><ion-scroll  on-scroll='scrollingEvent(\"year\")' delegate-handle='yearScroll_"+w+"' scrollbar-y='false' class='yearContent'><ul><li ng-style='year.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"year\",$index)' ng-repeat='year in yearList'>{{year.text}}</li></ul></ion-scroll></div><div class='col'  ng-if='!options.hideMonth' ><ion-scroll  on-scroll='scrollingEvent(\"month\")' delegate-handle='monthScroll_"+w+"' scrollbar-y='false' class='monthContent'><ul><li ng-style='month.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"month\",$index)' ng-repeat='month in monthList'>{{month.text}}</li></ul></ion-scroll></div><div class='col ' ng-if='!options.hideDate' ><ion-scroll on-scroll='scrollingEvent(\"date\")' delegate-handle='dateScroll_"+w+"' scrollbar-y='false' class='dateContent'><ul><li ng-style='date.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"date\",$index)' ng-repeat='date in dateList'>{{date.text}}</li></ul></ion-scroll></div><div class='col ' ng-if='!options.hideTime' ><ion-scroll on-scroll='scrollingEvent(\"time\")' delegate-handle='timeScroll_"+w+"' scrollbar-y='false' class='timeContent'><ul><li ng-style='time.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"time\",$index)' ng-repeat='time in timeList'>{{time.text}}</li></ul></ion-scroll></div></div><div class='body_center_highlight'></div></div><div class='footer'><span ng-click='ok()'>确定</span><span ng-click='cancel()'>取消</span></div></div></div>",I={title:s.title||"时间选择",height:40,timeNum:parseInt(s.timenum)||24,yearStart:s.yearstart&&parseInt(s.yearstart)||E.getFullYear()-20,yearEnd:s.yearend&&parseInt(s.yearend)||E.getFullYear()+20,monthStart:12,monthEnd:1,DateTime:s.datetime&&new Date(s.datetime)||E,timeSpan:s.timespan&&parseInt(s.timespan)||15,minuteSkip:s.minuteskip&&parseInt(s.minuteskip),loadLazy:s.loadlazy||!1,hideYear:s.hideyear||!1,hideMoth:s.hidemoth||!1,hideDate:s.hidedate||!1,hideTime:s.hidetime||!1,inModal:s.inmodal||!1};l.options=I,l.yearScrollTimer=null,l.monthScrollTimer=null,l.dateScrollTimer=null,l.timeScrollTimer=null,l.dateList=[],l.timeList=[],l.yearList=[],l.monthList=[],l.selectDateTime={year:{item:null,index:0},month:{item:null,index:0},date:{item:null,index:0},time:{item:null,index:0},show:""},l.specialDateTime={bigMoth:[1,3,5,7,8,10,12],isBigMonth:function(e){for(var t=this.bigMoth.length;t--;)if(this.bigMoth[t]==e)return!0;return!1},isLoopYear:function(e){return e%4==0&&(e%100!=0||e%400==0)}},I.loadLazy?l.$watch("loadDateTime",function(){l.loadDateTime&&(I.DateTime=new Date(l.loadDateTime),l.options=I,r(I))}):(l.options=I,r(I)),o.on("click",function(){x(),f(l.yearScroll,l.yearList[l.selectDateTime.year.index-3]),f(l.monthScroll,l.monthList[l.selectDateTime.month.index-3]),f(l.dateScroll,l.dateList[l.selectDateTime.date.index-3]),f(l.timeScroll,l.timeList[l.selectDateTime.time.index-3])}),l.scrollingEvent=function(t){var i=k(t);l[i.scrollTimer]&&e.cancel(l[i.scrollTimer]);var a=l[i.scrollHandler].getScrollPosition(),n=Math.abs(Math.round(a.top/l.options.height));a.top==n*l.options.height?y(n+3,t):l[i.scrollTimer]=e(function(){a.top=40*n,y(n+3,t),D(l[i.scrollHandler],a)},100)},l.selectEvent=function(e,t){var i=k(e);t>2&&t<=l[i.data].length-3&&f(l[i.scrollHandler],l[i.data][t-3])},l.ok=function(){var e=L();if(v(),M(),l.okHandler){var t=l.okHandler({result:e});console.log(t)}},l.cancel=function(){M()},l.$on("$destroy",function(){$()})}}}])}(window,document);