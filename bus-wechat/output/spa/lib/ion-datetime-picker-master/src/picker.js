angular.module("ion-datetime-picker",["ionic"]).directive("ionDatetimePicker",function(){return{restrict:"AE",require:"ngModel",scope:{modelDate:"=ngModel",title:"=?",subTitle:"=?",buttonOk:"=?",buttonCancel:"=?",monthStep:"=?",hourStep:"=?",minuteStep:"=?",secondStep:"=?",onlyValid:"=?"},controller:function($scope,$ionicPopup,$ionicPickerI18n,$timeout){function setNextValidDate(date,dayToAdd){dayToAdd=dayToAdd||0,0!==dayToAdd&&date.setDate(date.getDate()+dayToAdd),lastDateSet.year=date.getFullYear(),lastDateSet.month=date.getMonth(),lastDateSet.day=date.getDate(),lastDateSet.hour=date.getHours(),lastDateSet.minute=date.getMinutes(),lastDateSet.second=date.getSeconds(),lastDateSet.date=date}function setLastValidDate(){var date=new Date($scope.year,$scope.month,$scope.day,$scope.hour,$scope.minute,$scope.second);$scope.isEnabled(date.getDate(),!0)?setNextValidDate(date):($scope.year=lastDateSet.year,$scope.month=lastDateSet.month,$scope.day=lastDateSet.day,$scope.hour=lastDateSet.hour,$scope.minute=lastDateSet.minute,$scope.second=lastDateSet.second)}function createDate(stringDate){var date=new Date(stringDate),isInvalidDate=isNaN(date.getTime());return isInvalidDate&&(date=new Date),date.setHours(0,0,0,0,0),date}$scope.i18n=$ionicPickerI18n,$scope.bind={},$scope.rows=[0,1,2,3,4,5],$scope.cols=[1,2,3,4,5,6,7],$scope.weekdays=[0,1,2,3,4,5,6];var lastDateSet={year:$scope.year,month:$scope.month,day:$scope.day,hour:$scope.hour,minute:$scope.minute,second:$scope.second,date:new Date,getDateWithoutTime:function(){var tempDate=new Date(this.date);return tempDate.setHours(0,0,0,0,0),tempDate}};$scope.showPopup=function(){$ionicPopup.show({templateUrl:"lib/ion-datetime-picker/src/picker-popup.html",title:$scope.title||"选择 "+($scope.dateEnabled?"日期":"")+($scope.dateEnabled&&$scope.timeEnabled?" 和 ":"")+($scope.timeEnabled?"时间":""),subTitle:$scope.subTitle||"",scope:$scope,cssClass:"ion-datetime-picker-popup",buttons:[{text:$scope.buttonOk||$scope.i18n.ok,type:$scope.i18n.okClass,onTap:function(){$scope.commit()}},{text:$scope.buttonCancel||$scope.i18n.cancel,type:$scope.i18n.cancelClass,onTap:function(){$timeout(function(){$scope.processModel()},200)}}]})},$scope.prepare=function(){$scope.mondayFirst&&$scope.weekdays.push($scope.weekdays.shift())},$scope.processModel=function(){var date=$scope.modelDate instanceof Date?$scope.modelDate:new Date;$scope.year=$scope.dateEnabled?date.getFullYear():0,$scope.month=$scope.dateEnabled?date.getMonth():0,$scope.day=$scope.dateEnabled?date.getDate():0,$scope.hour=$scope.timeEnabled?date.getHours():0,$scope.minute=$scope.timeEnabled?date.getMinutes():0,$scope.second=$scope.secondsEnabled?date.getSeconds():0,changeViewData()};var changeViewData=function(){setLastValidDate();var date=new Date($scope.year,$scope.month,$scope.day,$scope.hour,$scope.minute,$scope.second);$scope.dateEnabled&&($scope.year=date.getFullYear(),$scope.month=date.getMonth(),$scope.day=date.getDate(),$scope.bind.year=$scope.year,$scope.bind.month=$scope.month,$scope.firstDay=new Date($scope.year,$scope.month,1).getDay(),$scope.mondayFirst&&($scope.firstDay=($scope.firstDay||7)-1),$scope.daysInMonth=getDaysInMonth($scope.year,$scope.month)),$scope.timeEnabled&&($scope.hour=date.getHours(),$scope.minute=date.getMinutes(),$scope.second=date.getSeconds(),$scope.meridiem=$scope.hour<12?"上午":"下午",$scope.bind.hour=$scope.meridiemEnabled?($scope.hour%12||12).toString():$scope.hour.toString(),$scope.bind.minute=($scope.minute<10?"0":"")+$scope.minute.toString(),$scope.bind.second=($scope.second<10?"0":"")+$scope.second.toString(),$scope.bind.meridiem=$scope.meridiem)},getDaysInMonth=function(year,month){return new Date(year,month+1,0).getDate()};$scope.changeBy=function(value,unit){if(+value){if(("hour"===unit||"minute"===unit)&&-1===value){var date=new Date($scope.year,$scope.month,$scope.day,$scope.hour-1,$scope.minute);0!==$scope.minute&&"hour"!==unit||$scope.hour!==date.getHours()||$scope.hour--}$scope[unit]+=+value,("month"===unit||"year"===unit)&&($scope.day=Math.min($scope.day,getDaysInMonth($scope.year,$scope.month))),changeViewData()}},$scope.change=function(unit){var value=$scope.bind[unit];value&&"meridiem"===unit?(value=value.toUpperCase(),"AM"===value&&"PM"===$scope.meridiem?$scope.hour-=12:"PM"===value&&"AM"===$scope.meridiem&&($scope.hour+=12),changeViewData()):(+value||0===+value)&&($scope[unit]=+value,("month"===unit||"year"===unit)&&($scope.day=Math.min($scope.day,getDaysInMonth($scope.year,$scope.month))),changeViewData())},$scope.changeDay=function(day){$scope.day=day,changeViewData()},$scope.isEnabled=function(day,computeNextValidDate){if(!$scope.onlyValid)return!0;var currentDate=new Date($scope.year,$scope.month,day),isValid=!0;if($scope.onlyValid.after){var afterDate=createDate($scope.onlyValid.after);$scope.onlyValid.inclusive?(isValid=currentDate>=afterDate,!isValid&&computeNextValidDate&&setNextValidDate(afterDate,0)):(isValid=currentDate>afterDate,!isValid&&computeNextValidDate&&setNextValidDate(afterDate,1))}else if($scope.onlyValid.before){var beforeDate=createDate($scope.onlyValid.after);$scope.onlyValid.inclusive?(isValid=beforeDate>=currentDate,!isValid&&computeNextValidDate&&setNextValidDate(beforeDate,0)):(isValid=beforeDate>currentDate,!isValid&&computeNextValidDate&&setNextValidDate(beforeDate,-1))}else if($scope.onlyValid.between){var initialDate=createDate($scope.onlyValid.between.initial),finalDate=createDate($scope.onlyValid.between.final);$scope.onlyValid.inclusive?(isValid=currentDate>=initialDate&&finalDate>=currentDate,!isValid&&computeNextValidDate&&(initialDate>currentDate&&setNextValidDate(initialDate,0),currentDate>finalDate&&setNextValidDate(finalDate,0))):(isValid=currentDate>initialDate&&finalDate>currentDate,!isValid&&computeNextValidDate&&(initialDate>=currentDate&&setNextValidDate(initialDate,1),currentDate>=finalDate&&setNextValidDate(finalDate,-1)))}else if($scope.onlyValid.outside){var initialDate=createDate($scope.onlyValid.outside.initial),finalDate=createDate($scope.onlyValid.outside.final);if($scope.onlyValid.inclusive){if(isValid=initialDate>=currentDate||currentDate>=finalDate,!isValid&&computeNextValidDate){var lastValidDate=lastDateSet.getDateWithoutTime();initialDate>=lastValidDate&&setNextValidDate(finalDate,0),lastValidDate>=finalDate&&setNextValidDate(initialDate,0)}}else if(isValid=initialDate>currentDate||currentDate>finalDate,!isValid&&computeNextValidDate){var lastValidDate=lastDateSet.getDateWithoutTime();initialDate>lastValidDate&&setNextValidDate(finalDate,1),lastValidDate>finalDate&&setNextValidDate(initialDate,-1)}}return isValid},$scope.changed=function(){changeViewData()},$scope.dateEnabled&&$scope.$watch(function(){return(new Date).getDate()},function(){var today=new Date;$scope.today={day:today.getDate(),month:today.getMonth(),year:today.getFullYear()}})},link:function($scope,$element,$attrs,ngModelCtrl){$scope.title="title"in $attrs&&$attrs.title,$scope.dateEnabled="date"in $attrs&&"false"!==$attrs.date,$scope.timeEnabled="time"in $attrs&&"false"!==$attrs.time,$scope.dateEnabled===!1&&$scope.timeEnabled===!1&&($scope.dateEnabled=$scope.timeEnabled=!0),$scope.mondayFirst="mondayFirst"in $attrs&&"false"!==$attrs.mondayFirst,$scope.secondsEnabled=$scope.timeEnabled&&"seconds"in $attrs&&"false"!==$attrs.seconds,$scope.meridiemEnabled=$scope.timeEnabled&&"amPm"in $attrs&&"false"!==$attrs.amPm,$scope.monthStep=+$scope.monthStep||1,$scope.hourStep=+$scope.hourStep||1,$scope.minuteStep=+$scope.minuteStep||1,$scope.secondStep=+$scope.secondStep||1,$scope.prepare(),ngModelCtrl.$render=function(){$scope.modelDate=ngModelCtrl.$viewValue,$scope.processModel()},$scope.commit=function(){$scope.modelDate=new Date($scope.year,$scope.month,$scope.day,$scope.hour,$scope.minute,$scope.second),ngModelCtrl.$setViewValue($scope.modelDate)},$element.on("click",$scope.showPopup)}}});