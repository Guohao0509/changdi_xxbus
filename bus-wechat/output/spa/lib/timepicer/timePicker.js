!function(){"use strict";angular.module("app").service("timePickerService",function(){var _this=this;return _this.globalId=0,_this.format=function(date,fmt){var o={"M+":date.getMonth()+1,"d+":date.getDate(),"h+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds(),"q+":Math.floor((date.getMonth()+3)/3),S:date.getMilliseconds()};/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(date.getFullYear()+"").substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt},_this}).directive("timePicker",["$timeout","$compile","$ionicScrollDelegate","$ionicBackdrop","$q","timePickerService",function($timeout,$compile,$ionicScrollDelegate,$ionicBackdrop,$q,timePickerService){return{template:"<div>{{selectDateTime.show}}</div>",restrict:"AE",replace:!0,scope:{format:"@",okHandler:"&",timePickerResult:"=",loadDateTime:"="},link:function(scope,elm,attrs){function init(options){options.hideYear?null:initYear(options),options.hideMoth?null:initMoth(options),options.hideDate?null:initDay(options),options.hideTime?null:initTime(options),tem=angular.element(tem),$compile(tem)(scope),angular.element(document.body).append(tem),getSelectDateTime(),setSelectDateTimeShow()}function initYear(options){scope.yearScroll=$ionicScrollDelegate.$getByHandle("yearScroll_"+globalId);var text,data,top,item,defaultItem,defaultIndex,defaultYear=options.DateTime.getFullYear(),yearSpan=options.yearEnd-options.yearStart;prependLi(scope.yearList,3,"b");for(var i=0;yearSpan>=i;i++)text=options.yearStart+i,data=options.yearStart+i,top=options.height+scope.yearList[scope.yearList.length-1].top,item=createDateTimeLi(0,top,data,data==defaultYear,text),data==defaultYear&&(defaultItem=item,defaultIndex=scope.yearList.length),scope.yearList.push(item);scope.selectDateTime.year.item=defaultItem,scope.selectDateTime.year.index=defaultIndex,prependLi(scope.yearList,3,"e")}function initMoth(options){scope.monthScroll=$ionicScrollDelegate.$getByHandle("monthScroll_"+globalId);var text,data,original,top,item,defaultItem,defaultIndex,defaultMonth=options.DateTime.getMonth()+1==0?12:prependZero(options.DateTime.getMonth()+1,10);prependLi(scope.monthList,3,"b");for(var i=1;12>=i;i++)original=i,data=prependZero(i,10),text=prependZero(i,10)+"月",top=options.height+scope.monthList[scope.monthList.length-1].top,item=createDateTimeLi(0,top,data,data==defaultMonth,text),data==defaultMonth&&(defaultItem=item,defaultIndex=scope.monthList.length),scope.monthList.push(item);scope.selectDateTime.month.item=defaultItem,scope.selectDateTime.month.index=defaultIndex,prependLi(scope.monthList,3,"e")}function initDay(options){scope.dateScroll=$ionicScrollDelegate.$getByHandle("dateScroll_"+globalId);var text,data,top,item,defaultItem,defaultIndex,defaultDay=prependZero(options.DateTime.getDate(),10),dateNum=getDateNum(options.DateTime.getFullYear(),options.DateTime.getMonth()+1);prependLi(scope.dateList,3,"b");for(var i=1;dateNum>=i;i++)data=prependZero(i,10),text=prependZero(i,10)+"日",top=options.height+scope.dateList[scope.dateList.length-1].top,item=createDateTimeLi(0,top,data,data==defaultDay,text),data==defaultDay&&(defaultItem=item,defaultIndex=scope.dateList.length),scope.dateList.push(item);scope.selectDateTime.date.item=defaultItem,scope.selectDateTime.date.index=defaultIndex,prependLi(scope.dateList,3,"e")}function initTime(options){scope.timeScroll=$ionicScrollDelegate.$getByHandle("timeScroll_"+globalId),console.log(options);var defaultItem,defaultIndex,defaultTime=getDefaultSelectTime(options);prependLi(scope.timeList,3,"b");for(var timeStart=options.DateTime.getHours(),i=0;i<options.timeNum;i++){var t=timeStart+i;t>=24?(t-=24,t=prependZero(t,10)):10>t&&(t=prependZero(t,10));for(var j=0;j<60/options.timeSpan;j++){var top=options.height+scope.timeList[scope.timeList.length-1].top,data=t+":"+(j*options.timeSpan==0?"00":j*options.timeSpan),item=createDateTimeLi(0,top,data,data==defaultTime,data);scope.timeList.push(item),data==defaultTime&&(defaultItem=item,defaultIndex=scope.timeList.length)}}prependLi(scope.timeList,3,"e"),scope.selectDateTime.time.item=defaultItem,scope.selectDateTime.time.index=defaultIndex-1}function getDefaultSelectTime(options){var hour,minu;if(options.minuteSkip||parseInt(options.DateTime.getMinutes()/options.timeSpan)!=options.DateTime.getMinutes()/options.timeSpan){options.minuteSkip=options.minuteSkip||30;var datetimeNow=new Date;hour=datetimeNow.getHours(),minu=datetimeNow.getMinutes(),minu+=options.minuteSkip;var spanNum,span=minu-60;switch(span>=0?(hour+=1,spanNum=Math.round(Math.abs(span)/options.timeSpan)):spanNum=Math.round(minu/options.timeSpan),spanNum){case 1:minu=options.timeSpan;break;case 2:minu=2*options.timeSpan;break;case 3:minu=3*options.timeSpan;break;case 4:hour+=1,minu=0;default:minu=0}}else hour=options.DateTime.getHours(),minu=options.DateTime.getMinutes();return prependZero(hour,10)+":"+prependZero(minu,10)}function prependZero(data,num){return data>=num?data:"0"+data}function createDateTimeLi(left,top,data,selected,text){var li={left:left,top:top,data:data,selected:selected,text:text};return li}function prependLi(arr,num,loc){switch(loc=loc||"b"){case"b":for(var i=0;num>i;i++)arr.push(createDateTimeLi(0,options.height*i,"",!1,""));break;case"e":for(var lastPosiTop=arr[arr.length-1].top,j=0;num>j;j++)arr.push(createDateTimeLi(0,options.height*(i+1)+lastPosiTop,"",!1,""))}}function scrollToElm(scorllHandler,elm){scorllHandler.scrollTo(elm.left,elm.top,!0)}function scrollToPosi(scorllHandler,posi){scorllHandler.scrollTo(posi.left,posi.top,!0)}function updateSelect(index,type){switch(type){case"year":$timeout(function(){scope.selectDateTime.year.item.selected=!1,scope.yearList[index].selected=!0,scope.selectDateTime.year.item=scope.yearList[index],scope.selectDateTime.year.index=index,resettingDate(scope.selectDateTime.year.item.data,parseInt(scope.selectDateTime.month.item.data))});break;case"month":$timeout(function(){scope.selectDateTime.month.item.selected=!1,scope.monthList[index].selected=!0,scope.selectDateTime.month.item=scope.monthList[index],scope.selectDateTime.month.index=index,resettingDate(scope.selectDateTime.year.item.data,parseInt(scope.selectDateTime.month.item.data))});break;case"date":$timeout(function(){scope.selectDateTime.date.item.selected=!1,scope.dateList[index].selected=!0,scope.selectDateTime.date.item=scope.dateList[index],scope.selectDateTime.date.index=index});break;case"time":$timeout(function(){scope.selectDateTime.time.item.selected=!1,scope.timeList[index].selected=!0,scope.selectDateTime.time.item=scope.timeList[index],scope.selectDateTime.time.index=index})}}function setSelectDateTimeShow(){scope.selectDateTime.show=(scope.options.hideYear?"":scope.selectDateTime.year.item.text+" ")+(scope.options.hideMoth?"":scope.selectDateTime.month.item.text)+(scope.options.hideDate?"":scope.selectDateTime.date.item.text+" ")+(scope.options.hideTime?"":scope.selectDateTime.time.item.text)}function getSelectDateTime(){var value=(scope.options.hideYear?"":scope.selectDateTime.year.item.data+"-")+(scope.options.hideMoth?"":scope.selectDateTime.month.item.data+"-")+(scope.options.hideDate?"":scope.selectDateTime.date.item.data+" ")+(scope.options.hideTime?"":scope.selectDateTime.time.item.data);return scope.timePickerResult=scope.format?timePickerService.format(new Date(value),scope.format):value,scope.timePickerResult}function getDateNum(year,month){var dateNum=30;return scope.specialDateTime.isBigMonth(month)?dateNum++:scope.specialDateTime.isLoopYear(year)?2==month&&dateNum--:2==month&&(dateNum-=2),dateNum}function resettingDate(year,month){var dateNum=getDateNum(year,month);if(dateNum!=scope.dateList.length-6){var text,data,top,item,refreshNum=dateNum-(scope.dateList.length-6);if(refreshNum>0)for(var lastData=scope.dateList[scope.dateList.length-4],i=1;refreshNum>=i;i++)data=lastData.data+i,text=data+"日",top=options.height+scope.dateList[scope.dateList.length-4].top,item=createDateTimeLi(0,top,data,!1,text),scope.dateList.splice(scope.dateList.length-3,0,item);else{var refreshNum_=Math.abs(refreshNum);scope.dateList.splice(scope.dateList.length-4-refreshNum_+1,refreshNum_),scope.selectDateTime.date.item.data>scope.dateList[scope.dateList.length-4].data&&(scope.dateList[scope.dateList.length-4].selected=!0,scope.selectDateTime.date.item=scope.dateList[scope.dateList.length-4],scope.selectDateTime.date.item.index=scope.dateList.length-4,scrollToElm(scope.dateScroll,scope.dateList[scope.selectDateTime.date.index-3]))}}}function getOperateEntity(type){var entity=new Object;switch(type){case"year":entity.scrollTimer="yearScrollTimer",entity.type=type,entity.scrollHandler="yearScroll",entity.data="yearList",entity.defaultSelected=scope.selectDateTime.year.item.data,entity.selectedItem="year";break;case"month":entity.scrollTimer="monthScrollTimer",entity.type=type,entity.scrollHandler="monthScroll",entity.data="monthList",entity.defaultSelected=scope.selectDateTime.month.item.data,entity.selectedItem="month";break;case"date":entity.scrollTimer="dateScrollTimer",entity.type=type,entity.scrollHandler="dateScroll",entity.data="dateList",entity.defaultSelected=scope.selectDateTime.date.item.data,entity.selectedItem="date";break;case"time":entity.scrollTimer="timeScrollTimer",entity.type=type,entity.scrollHandler="timeScroll",entity.data="timeList",entity.defaultSelected=scope.selectDateTime.time.item.data,entity.selectedItem="time"}return entity}function show(){scope.options.inModal&&angular.element(document.body).removeClass("modal-open"),$ionicBackdrop.retain(),tem.css("display","block")}function hide(){scope.options.inModal&&angular.element(document.body).addClass("modal-open"),tem.css("display","none"),$ionicBackdrop.release()}function remove(){tem.remove()}var globalId=++timePickerService.globalId,dateTimeNow=new Date,tem="<div class='pickerContainer datetimeactive'><div class='main'><div  class='header'><div>{{options.title}}</div></div><div class='body'><div class='row row-no-padding'><div class='col'  ng-if='!options.hideYear' ><ion-scroll  on-scroll='scrollingEvent(\"year\")' delegate-handle='yearScroll_"+globalId+"' scrollbar-y='false' class='yearContent'><ul><li ng-style='year.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"year\",$index)' ng-repeat='year in yearList'>{{year.text}}</li></ul></ion-scroll></div><div class='col'  ng-if='!options.hideMonth' ><ion-scroll  on-scroll='scrollingEvent(\"month\")' delegate-handle='monthScroll_"+globalId+"' scrollbar-y='false' class='monthContent'><ul><li ng-style='month.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"month\",$index)' ng-repeat='month in monthList'>{{month.text}}</li></ul></ion-scroll></div><div class='col ' ng-if='!options.hideDate' ><ion-scroll on-scroll='scrollingEvent(\"date\")' delegate-handle='dateScroll_"+globalId+"' scrollbar-y='false' class='dateContent'><ul><li ng-style='date.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"date\",$index)' ng-repeat='date in dateList'>{{date.text}}</li></ul></ion-scroll></div><div class='col ' ng-if='!options.hideTime' ><ion-scroll on-scroll='scrollingEvent(\"time\")' delegate-handle='timeScroll_"+globalId+"' scrollbar-y='false' class='timeContent'><ul><li ng-style='time.selected ? { color: \"#0081b8\",fontWeight: \"bold\", fontSize: \"1.2em\"}:{}' ng-click='selectEvent(\"time\",$index)' ng-repeat='time in timeList'>{{time.text}}</li></ul></ion-scroll></div></div><div class='body_center_highlight'></div></div><div class='footer'><span ng-click='ok()'>确定</span><span ng-click='cancel()'>取消</span></div></div></div>",options={title:attrs.title||"时间选择",height:40,timeNum:parseInt(attrs.timenum)||24,yearStart:attrs.yearstart&&parseInt(attrs.yearstart)||dateTimeNow.getFullYear()-20,yearEnd:attrs.yearend&&parseInt(attrs.yearend)||dateTimeNow.getFullYear()+20,monthStart:12,monthEnd:1,DateTime:attrs.datetime&&new Date(attrs.datetime)||dateTimeNow,timeSpan:attrs.timespan&&parseInt(attrs.timespan)||15,minuteSkip:attrs.minuteskip&&parseInt(attrs.minuteskip),loadLazy:attrs.loadlazy||!1,hideYear:attrs.hideyear||!1,hideMoth:attrs.hidemoth||!1,hideDate:attrs.hidedate||!1,hideTime:attrs.hidetime||!1,inModal:attrs.inmodal||!1};scope.options=options,scope.yearScrollTimer=null,scope.monthScrollTimer=null,scope.dateScrollTimer=null,scope.timeScrollTimer=null,scope.dateList=[],scope.timeList=[],scope.yearList=[],scope.monthList=[],scope.selectDateTime={year:{item:null,index:0},month:{item:null,index:0},date:{item:null,index:0},time:{item:null,index:0},show:""},scope.specialDateTime={bigMoth:[1,3,5,7,8,10,12],isBigMonth:function(month){for(var length=this.bigMoth.length;length--;)if(this.bigMoth[length]==month)return!0;return!1},isLoopYear:function(year){return year%4==0&&(year%100!=0||year%400==0)}},options.loadLazy?scope.$watch("loadDateTime",function(){scope.loadDateTime&&(options.DateTime=new Date(scope.loadDateTime),scope.options=options,init(options))}):(scope.options=options,init(options)),elm.on("click",function(){show(),scrollToElm(scope.yearScroll,scope.yearList[scope.selectDateTime.year.index-3]),scrollToElm(scope.monthScroll,scope.monthList[scope.selectDateTime.month.index-3]),scrollToElm(scope.dateScroll,scope.dateList[scope.selectDateTime.date.index-3]),scrollToElm(scope.timeScroll,scope.timeList[scope.selectDateTime.time.index-3])}),scope.scrollingEvent=function(type){var opEntity=getOperateEntity(type);scope[opEntity.scrollTimer]&&$timeout.cancel(scope[opEntity.scrollTimer]);var posi=scope[opEntity.scrollHandler].getScrollPosition(),index=Math.abs(Math.round(posi.top/scope.options.height));posi.top==index*scope.options.height?updateSelect(index+3,type):scope[opEntity.scrollTimer]=$timeout(function(){posi.top=40*index,updateSelect(index+3,type),scrollToPosi(scope[opEntity.scrollHandler],posi)},100)},scope.selectEvent=function(type,index){var opEntity=getOperateEntity(type);index>2&&index<=scope[opEntity.data].length-3&&scrollToElm(scope[opEntity.scrollHandler],scope[opEntity.data][index-3])},scope.ok=function(){var datetime=getSelectDateTime();if(setSelectDateTimeShow(),hide(),scope.okHandler){var aa=scope.okHandler({result:datetime});console.log(aa)}},scope.cancel=function(){hide()},scope.$on("$destroy",function(){remove()})}}}])}(window,document);