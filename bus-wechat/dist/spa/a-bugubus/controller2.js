var app=angular.module("app").controller("bus_service_1",function($rootScope,$scope,$state,$filter,$myLocationService){if($scope.onewayformdata={},$scope.backformdata={},$scope.thenerveformadata={},$scope.ioncheck={},$scope.onTabSelected=function(index){$scope.charterType=index},$scope.ioncheck.checked=!1,$rootScope.startLocation){var data=$rootScope.startLocation;$scope.startLocation=data.name,$scope.startLocationlnglat=data.lngLat}else $myLocationService.getCurrentPosition(function(data){if(data.length>0){var data=data[0];$rootScope.startLocation={name:data.name,lngLat:data.location.lng+","+data.location.lat},$scope.startLocation=data.name,$scope.startLocationlnglat=data.location.lng+","+data.location.lat,$scope.$apply()}else $scope.startLocation="无法获取你的位置",$scope.startLocationlnglat="0,0",$scope.$apply()});if($rootScope.endLocation){var data=$rootScope.endLocation;$scope.endLocation=data.name,$scope.endLocationlnglat=data.lngLat}$scope.selectLocation=function(params,status){$state.go("select_location",{params:params,status:status})},$scope.onewayformdata={StartTime:"出发时间",charterStartTime:new Date,EndTime:"结束时间",charterEndTime:new Date},$scope.backformdata={StartTime:"出发时间",charterStartTime:new Date,EndTime:"结束时间",charterEndTime:new Date},$scope.thenerveformadata={StartTime:"出发时间",charterStartTime:new Date,EndTime:"结束时间",charterEndTime:new Date},$scope.gotobusservice3=function(startLocation,endLocation){$scope.userid=$rootScope.session.user.userInfo.userid;var usermessobj={};1==$scope.charterType?usermessobj={userid:$scope.userid,startLocation:startLocation,startLoLa:$scope.startLocationlnglat,endLocation:endLocation,endLoLa:$scope.endLocationlnglat,charterType:$scope.charterType,needInfo:$scope.ioncheck.checked,charterStartTime:$filter("date")($scope.onewayformdata.charterStartTime,"yyyy-MM-dd HH:mm"),charterEndTime:$filter("date")($scope.onewayformdata.charterEndTime,"yyyy-MM-dd HH:mm"),charterCount:$scope.onewayformdata.charterCount}:2==$scope.charterType?usermessobj={userid:$scope.userid,startLocation:startLocation,startLoLa:$scope.startLocationlnglat,endLocation:endLocation,endLoLa:$scope.endLocationlnglat,charterType:$scope.charterType,needInfo:$scope.ioncheck.checked,charterStartTime:$filter("date")($scope.backformdata.charterStartTime,"yyyy-MM-dd HH:mm"),charterEndTime:$filter("date")($scope.backformdata.charterEndTime,"yyyy-MM-dd HH:mm"),charterCount:$scope.backformdata.charterCount}:3==$scope.charterType&&(usermessobj={userid:$scope.userid,startLocation:startLocation,startLoLa:$scope.startLocationlnglat,endLocation:endLocation,endLoLa:$scope.endLocationlnglat,charterType:$scope.charterType,needInfo:$scope.ioncheck.checked,charterStartTime:$filter("date")($scope.thenerveformadata.charterStartTime,"yyyy-MM-dd HH:mm"),charterEndTime:$filter("date")($scope.thenerveformadata.charterEndTime,"yyyy-MM-dd HH:mm"),charterCount:$scope.thenerveformadata.charterCount});var chartercount=/[^\d]/g;if(void 0==usermessobj.endLocation||""==usermessobj.endLocation)return void layer.msg("请输入目的地");if(chartercount.test(usermessobj.charterCount))return void layer.msg("请输入正确的乘车人数");$scope.formtime={oneformstartdate:$filter("date")($scope.onewayformdata.charterStartTime,"yyyy-MM-dd HH:mm"),oneformendtime:$filter("date")($scope.onewayformdata.charterEndTime,"yyyy-MM-dd HH:mm"),twoformstartdate:$filter("date")($scope.backformdata.charterStartTime,"yyyy-MM-dd HH:mm"),twoformendtime:$filter("date")($scope.backformdata.charterEndTime,"yyyy-MM-dd HH:mm"),thereformstartdate:$filter("date")($scope.thenerveformadata.charterStartTime,"yyyy-MM-dd HH:mm"),thereformendtime:$filter("date")($scope.thenerveformadata.charterEndTime,"yyyy-MM-dd HH:mm")};var time=new Date,month=time.getMonth()+1,day=time.getDate(),hours=time.getHours(),min=time.getMinutes();10>month&&(month="0"+month),10>day&&(day="0"+day),10>hours&&(hours="0"+hours),10>min&&(min="0"+min);var windowdate=time.getFullYear()+"-"+month+"-"+day+" "+hours+":"+min;if(1==usermessobj.charterType){if($scope.formtime.oneformstartdate>$scope.formtime.oneformendtime)return layer.msg("结束时间不能小于开始时间"),!1;if($scope.formtime.oneformstartdate==$scope.formtime.oneformendtime)return layer.msg("请输入正确的时间"),!1;if($scope.formtime.oneformstartdate<windowdate)return layer.msg("出发时间已经过了哦"),!1;if($scope.formtime.oneformendtime<windowdate)return layer.msg("结束时间已经过了哦"),!1}else if(2==usermessobj.charterType){if($scope.formtime.twoformstartdate>$scope.formtime.twoformendtime)return layer.msg("结束时间不能小于开始时间"),!1;if($scope.formtime.twoformstartdate==$scope.formtime.twoformendtime)return layer.msg("请输入正确的时间"),!1;if($scope.formtime.twoformstartdate<windowdate)return layer.msg("出发时间已经过了哦"),!1;if($scope.formtime.twoformendtime<windowdate)return layer.msg("结束时间已经过了哦"),!1}else if(3==usermessobj.charterType){if($scope.formtime.thereformstartdate>$scope.formtime.thereformendtime)return layer.msg("结束时间不能小于开始时间"),!1;if($scope.formtime.thereformstartdate==$scope.formtime.thereformendtime)return layer.msg("请输入正确的时间"),!1;if($scope.formtime.thereformstartdate<windowdate)return layer.msg("出发时间已经过了哦"),!1;if($scope.formtime.thereformendtime<windowdate)return layer.msg("结束时间已经过了哦"),!1}$state.go("bus_service_mess",{usermessobj:JSON.stringify(usermessobj)})}}).controller("bus_service_2",function($rootScope,$scope,$state,$myHttpService){$scope.argee=!0,$scope.agreeChange=function(){$scope.argee=!$scope.argee},$scope.usermesschartype={1:"单程",2:"往返",3:"包天"},$scope.needinfotype={"true":"需要司机","false":"不需要司机"},$scope.usermessobj=JSON.parse($state.params.usermessobj),$scope.usermessobj.charterCount=parseInt($scope.usermessobj.charterCount),$scope.buservice=function(){var info=/^[\u4e00-\u9fa5]{2,4}$/;if(void 0==$scope.usermessobj.commName)return layer.msg("请输入联系人昵称"),!1;if(!info.test($scope.usermessobj.commName))return layer.msg("请输入正确的联系人昵称"),!1;var tellinfo=/^1[34578]\d{9}$/;return void 0==$scope.usermessobj.commMobile||""==$scope.usermessobj.commMobile?(layer.msg("请输入联系方式"),!1):tellinfo.test($scope.usermessobj.commMobile)?(console.log($scope.usermessobj.repInfo),void 0!=$scope.usermessobj.repInfo&&""!=$scope.usermessobj.repInfo&&$scope.usermessobj.repInfo.length>100?(layer.msg("输入内容长度不能超过100个字,请重新输入"),!1):void $myHttpService.post("api/charterOrder/newCharterCase",$scope.usermessobj,function(data){$state.go("bus_submit_success",{charterid:data.charterid,caseStatus:data.caseStatus},{location:"replace"})})):(layer.msg("请输入正确的联系方式"),!1)}}).controller("bus_service_all",function($scope,$http,$myHttpService,$stateParams,$state){$scope.caseStatus=$state.params.caseStatus,$scope.usercharteridmess={charterid:$state.params.charterid},$myHttpService.post("api/charterOrder/CharterCaseDetails",$scope.usercharteridmess,function(data){$scope.usermess={userid:data.userid,startLocation:data.startLocation,endLocation:data.endLocation,charterStartTime:data.charterStartTime,charterEndTime:data.charterEndTime,charterCount:data.charterCount,charterType:data.charterType,commName:data.commName,commMobile:data.commMobile,reqInfo:data.reqInfo,caseStatus:data.caseStatus,totalfee:data.totalfee,needInfo:data.needInfo},console.log(JSON.stringify(data))}),$scope.charterTypestaus={1:"单程",2:"往返",3:"包天"},$scope.usercaseStatus={1:"待审核",2:"审核失败",3:"未支付",4:"支付失败",5:"已支付",6:"已完成"},$scope.needinfostaus={"true":"需要司机","false":"不需要司机"},$scope.pay=function(){"1"==$scope.usermess.caseStatus?layer.msg("请等待管理员审核"):"3"==$scope.usermess.caseStatus||"4"==$scope.usermess.caseStatus?$state.go("bus_service_pay",{totalfee:$scope.usermess.totalfee,charterid:$scope.usercharteridmess.charterid}).replace():("5"==$scope.usermess.caseStatus||"6"==$scope.usermess.caseStatus)&&layer.msg("此订单已完成")}}).controller("charterpayController",function($scope,$myHttpService,$rootScope,$location,$state){$scope.totalfee=$state.params.totalfee,$scope.charterid=$state.params.charterid,$scope.nextpay=function(){$myHttpService.post("api/payOrder/newPayCase",{charterid:$scope.charterid,userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid},function(data){function onBridgeReady(){WeixinJSBridge.invoke("getBrandWCPayRequest",data,function(res){"get_brand_wcpay_request:ok"==res.err_msg?$myHttpService.post("api/payOrder/verifyWxorderStatus",{rechargeid:data.rechargeid},function(){alert("您本次成功充值了"+$scope.totalfee+"元"),$location.url("/bus_service_history").replace()},function(){alert("支付失败，请联系客服处理。")}):alert("get_brand_wcpay_request:cancel"==res.err_msg?"你取消了本次支付":"支付失败，请联系客服处理。")})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady()})}}).controller("bus_submit_success",function($scope,$location,$state){$scope.caseStatus=$state.params.caseStatus,$scope.charterid=$state.params.charterid,$scope.querystuts=function(){$state.go("bus_service_all",{caseStatus:$scope.caseStatus,charterid:$state.params.charterid}).replace()}}).controller("bus_service_history",function($scope,$http,$myHttpService,$rootScope,$stateParams,$location,$ionicScrollDelegate,$state){$scope.userallmess=[],$scope.offset=0,$scope.pagesize=20,$scope.count=0,$scope.showMoreBtn=!1,$scope.getData=function(){$myHttpService.post("api/charterOrder/queryOrderRecords",{userid:$rootScope.session.user.userInfo.userid,offset:$scope.offset,pagesize:$scope.pagesize},function(data){$scope.totalnum=data.totalnum,$scope.queryusertype={1:"单程",2:"往返",3:"包天"},$scope.queryuserstaus={1:"待审核",2:"审核失败",3:"未支付",4:"支付失败",5:"已支付",6:"已完成"},$scope.showMoreBtn=$scope.totalnum-($scope.offset+$scope.pagesize)>0?!0:!1,$scope.$broadcast("scroll.refreshComplete"),$scope.userallmess=data.body,window.setTimeout(function(){$ionicScrollDelegate.resize()},0)})},$scope.bus_service_all=function(item){$state.go("bus_service_all",{charterid:item.charterid,caseStatus:item.caseStatus})},$scope.getData(),$scope.refresh=function(){$scope.offset=0,$myHttpService.postNoLoad("api/charterOrder/queryOrderRecords",{userid:$rootScope.session.user.userInfo.userid,offset:$scope.offset,pagesize:$scope.pagesize},function(data){$scope.totalnum=data.totalnum,$scope.showMoreBtn=$scope.totalnum-($scope.offset+$scope.pagesize)>0?!0:!1,$scope.$broadcast("scroll.refreshComplete"),$scope.userallmess=data.body,window.setTimeout(function(){$ionicScrollDelegate.resize()},0),layer.msg("刷新成功")})},$scope.getMoreData=function(){$scope.offset=$scope.offset+$scope.pagesize,$myHttpService.post("api/charterOrder/queryOrderRecords",{userid:$rootScope.session.user.userInfo.userid,offset:$scope.offset,pagesize:$scope.pagesize},function(data){$scope.totalnum=data.totalnum,$scope.showMoreBtn=$scope.totalnum-($scope.offset+$scope.pagesize)>0?!0:!1,$scope.userallmess=$scope.userallmess.concat(data.body),window.setTimeout(function(){$ionicScrollDelegate.resize()},0)})}}).controller("ScheduleTicketPay",function($rootScope,$scope,$location,$state,$stateParams,$myHttpService,$filter,$window){var arrayObj=null===$window.localStorage.getItem("saveMess")?[]:JSON.parse($window.localStorage.getItem("saveMess"));$scope.agreeStatus=!0,$scope.agreeStatusChange=function(){$scope.agreeStatus=!$scope.agreeStatus},$scope.orderInfo={payType:"0"},$scope.status=!1,$scope.moneypay={},$scope.moneypay.checked=!1,$scope.orderInfo.payType=!0,0==$stateParams.chargingtype&&$myHttpService.post("api/busline/queryCycleBusSchedulePrice",{bsid:$stateParams.bsid,userid:$rootScope.session.user.userInfo.userid,pdepartaddr:$stateParams.staddr,parriveaddr:$stateParams.edaddr},function(data){var orderInfo={bsid:data.busSchedule.bsid,linename:data.busSchedule.linename,depart:data.pdepartaddr,arrive:data.parriveaddr,totalMoney:parseFloat($stateParams.addprice),plateNum:data.busSchedule.platenum,goDepartTime:data.busSchedule.departtime,backDepartTime:data.busSchedule.arrivetime,startDate:data.startdate,endDate:data.enddate},date=new Date(data.startdate);if(orderInfo.year=date.getFullYear(),orderInfo.month=date.getMonth()+1,orderInfo.chargingtype=$stateParams.chargingtype,$scope.status=!0,arrayObj.length>0){for(var flag=!1,m=0;m<arrayObj.length;m++)if(orderInfo.bsid==arrayObj[m].bsid&&arrayObj[m].chargingtype==orderInfo.chargingtype&&arrayObj[m].depart==orderInfo.depart&&arrayObj[m].arrive==orderInfo.arrive){flag=!0,layer.msg("请勿重复选择车票");break}flag||arrayObj.push(orderInfo)}else arrayObj.push(orderInfo);$scope.orderList=arrayObj;for(var paymoney=0,order=0;order<$scope.orderList.length;order++)paymoney+=$scope.orderList[order].totalMoney;$scope.orderList.ticketmoney=paymoney;for(var ticketArr=[],b=0;b<arrayObj.length;b++)ticketArr.push(arrayObj[b].bsid+"&"+$filter("date")(arrayObj[b].startDate,"yyyy-MM-dd")+"&"+arrayObj[b].chargingtype+"&"+arrayObj[b].depart+"&"+arrayObj[b].arrive);$scope.tickeObj=ticketArr}),2==$stateParams.chargingtype&&$myHttpService.post("api/busline/queryCycleBusScheduleSinglePrice",{userid:$rootScope.session.user.userInfo.userid,bsid:$stateParams.bsid,pdepartaddr:$stateParams.staddr,parriveaddr:$stateParams.edaddr},function(data){var orderInfo={bsid:data.busSchedule.bsid,linename:data.busSchedule.linename,depart:data.pdepartaddr,arrive:data.parriveaddr,totalMoney:parseFloat($stateParams.addprice),plateNum:data.busSchedule.platenum,goDepartTime:data.busSchedule.departtime,backDepartTime:data.busSchedule.backDeparttime,startDate:data.usedate,endDate:data.enddate,price:data.busSchedule.price},date=new Date(data.usedate);if(orderInfo.year=date.getFullYear(),orderInfo.month=date.getMonth()+1,orderInfo.day=date.getDate(),orderInfo.chargingtype=$stateParams.chargingtype,$scope.status=!0,arrayObj.length>0){for(var flag=!1,m=0;m<arrayObj.length;m++)if(orderInfo.bsid==arrayObj[m].bsid&&arrayObj[m].chargingtype==orderInfo.chargingtype&&arrayObj[m].depart==orderInfo.depart&&arrayObj[m].arrive==orderInfo.arrive){flag=!0,layer.msg("请勿重复选择车票");break}flag||arrayObj.push(orderInfo)}else arrayObj.push(orderInfo);$scope.orderList=arrayObj;for(var paymoney=0,order=0;order<$scope.orderList.length;order++)paymoney+=$scope.orderList[order].totalMoney;$scope.orderList.ticketmoney=paymoney}),$scope.setObject=function(key,value){$window.localStorage[key]=angular.toJson(value),$state.go("schedule_opened")},$scope.removeDate=function(val){arrayObj.splice(val,1),$window.localStorage.saveMess=angular.toJson(arrayObj),$scope.$watch("orderList",function(){for(var paymoney=0,order=0;order<$scope.orderList.length;order++)paymoney+=$scope.orderList[order].totalMoney;$scope.orderList.ticketmoney=paymoney,""==$scope.orderList&&($scope.status=!0,$scope.status=!$scope.status)})},$scope.selectDate=function(){$location.url("/schedule_opened").replace()},$myHttpService.post("api/user/queryUserBarcode",{userid:$rootScope.session.user.userInfo.userid},function(data){$scope.balance=parseFloat(data.user.balance)}),$scope.submitOrder=function(){if(0==$scope.orderInfo.payType&&1==$scope.moneypay.checked){if(0==$scope.balance)return void layer.msg("储值卡余额不足，请更换支付方式");if($scope.balance<$scope.orderList.ticketmoney)return void layer.msg("储值卡余额不足，请更换支付方式")}if(0==$scope.orderInfo.payType&&0==$scope.moneypay.checked)return void layer.msg("请选择支付方式");if(1==$scope.moneypay.checked&&1==$scope.orderInfo.payType&&$scope.balance>$scope.orderList.ticketmoney)return void layer.msg("您的余额充裕,请使用储值卡支付");for(var ticketArr=[],b=0;b<$scope.orderList.length;b++)ticketArr.push($scope.orderList[b].bsid+"&"+$filter("date")($scope.orderList[b].startDate,"yyyy-MM-dd")+"&"+$scope.orderList[b].chargingtype+"&"+arrayObj[b].depart+"&"+arrayObj[b].arrive);$scope.tickeObj=ticketArr,$myHttpService.post("api/busline/buyMonthTicket",{userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,bsid:$scope.tickeObj,moneycar:$scope.moneypay.checked},function(data){function onBridgeReady(){WeixinJSBridge.invoke("getBrandWCPayRequest",data,function(res){"get_brand_wcpay_request:ok"==res.err_msg?$myHttpService.post("api/recharge/verifyWxorderStatus",{rechargeid:data.rechargeid},function(){$window.localStorage.clear(),$location.url("/ticket/pay_success?orderList="+JSON.stringify($scope.orderList)).replace()},function(){alert("支付失败，请联系客服处理。")}):alert("get_brand_wcpay_request:cancel"==res.err_msg?"你取消了本次支付":"支付失败，请联系客服处理。")})}0==$scope.moneypay.checked||1==$scope.moneypay.checked&&1==$scope.orderInfo.payType?"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady():1==$scope.moneypay.checked&&($window.localStorage.clear(),$location.url("/ticket/pay_success?orderList="+JSON.stringify($scope.orderList)).replace())})}}).controller("ScheduleTicketdayPay",function($rootScope,$scope,$location,$state,$stateParams,$myHttpService,$filter,$window){var arrayObj=null===$window.localStorage.getItem("saveMess")?[]:JSON.parse($window.localStorage.getItem("saveMess"));$scope.setObject=function(key,value){$window.localStorage[key]=JSON.stringify(value),$state.go("schedule_opened")},$scope.agreeStatus=!0,$scope.agreeStatusChange=function(){$scope.agreeStatus=!$scope.agreeStatus},$scope.orderInfo={payType:"0"},$scope.status=!1,$myHttpService.post("api/busline/queryCycleBusScheduleSinglePrice",{userid:$rootScope.session.user.userInfo.userid,bsid:$stateParams.bsid},function(data){var orderInfo={bsid:data.busSchedule.bsid,linename:data.busSchedule.linename,depart:data.busSchedule.departaddr,arrive:data.busSchedule.arriveaddr,totalMoney:data.totalpay,plateNum:data.busSchedule.platenum,goDepartTime:data.busSchedule.departtime,backDepartTime:data.busSchedule.backDeparttime,startDate:data.startdate,endDate:data.enddate,price:data.busSchedule.price,chargingtype:data.busSchedule.chargingtype},date=new Date(data.usedate);if(orderInfo.year=date.getFullYear(),orderInfo.month=date.getMonth()+1,orderInfo.day=date.getDate(),orderInfo.chargingtype=$stateParams.chargingtype,$scope.status=!0,arrayObj.length>0)for(var m=0;m<arrayObj.length;m++){if(orderInfo.bsid!=arrayObj[m].bsid){arrayObj.push(orderInfo);break}layer.msg("请勿重复选择车票")}else arrayObj.push(orderInfo);$scope.orderList=arrayObj;for(var paymoney=0,order=0;order<$scope.orderList.length;order++)paymoney+=$scope.orderList[order].totalMoney;$scope.ticketmoney=paymoney;for(var ticketArr=[],b=0;b<arrayObj.length;b++)ticketArr.push(arrayObj[b].bsid+"&"+$filter("date")(arrayObj[b].startDate,"yyyy-MM-dd")+"&"+arrayObj[b].chargingtype);$scope.tickeObj=ticketArr}),$scope.submitOrder=function(){$myHttpService.post("api/busline/buySingleTicket",{userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,bsid:$scope.tickeObj},function(data){function onBridgeReady(){WeixinJSBridge.invoke("getBrandWCPayRequest",data,function(res){"get_brand_wcpay_request:ok"==res.err_msg?$myHttpService.post("api/recharge/verifyWxorderStatus",{rechargeid:data.rechargeid},function(){$window.localStorage.clear(),$location.url("/ticket/pay_success?orderInfo="+JSON.stringify($scope.orderInfo)).replace()},function(){alert("支付失败，请联系客服处理。")}):alert("get_brand_wcpay_request:cancel"==res.err_msg?"你取消了本次支付":"支付失败，请联系客服处理。")})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady()})}}).controller("ScheduleDetailController",function($ionicPopup,$window,$rootScope,$scope,$stateParams,$location,$state,$ionicLoading,$myHttpService,$interval){$scope.mode=$stateParams.mode;var map=null,drving=null;$scope.goSchedule={},$scope.goLine={},$scope.backLine={},$scope.stopStationobj=JSON.parse($stateParams.stopStationobj),$scope.init=function(){for(var addprice=0,p=parseInt($scope.stopStationobj.startIndex)+1;p<=$scope.stopStationobj.endIndex;p++)addprice+=$scope.stopStationobj.stopstation[p].price;$scope.addprice=addprice;for(var addtime=0,m=parseInt($scope.stopStationobj.startIndex)+1;m<=$scope.stopStationobj.endIndex;m++)addtime+=$scope.stopStationobj.stopstation[m].driverTime;$scope.addtime=addtime},$scope.init(),$scope.expandStatus=!1;var MapOperation={clearMap:function(){map.clearMap()},addMarkers:function(buslines){for(var i=0,len=buslines.length;len>i;i++){var text="<div class='marker station-marker'>"+i+"</div>";0==i?text="<div class='marker start-marker'>起</div>":i==len-1&&(text="<div class='marker stop-marker'>终</div>");{new AMap.Marker({map:map,position:new AMap.LngLat(buslines[i].lng,buslines[i].lat),content:text,extData:buslines[i],draggable:!1})}}},addPolyline:function(polyline){var polyline=new AMap.Polyline({path:polyline,strokeColor:"#3366FF",strokeOpacity:1,strokeWeight:5,strokeStyle:"solid",strokeDasharray:[10,5]});polyline.setMap(map),map.setFitView()},drivingSearch:function(stations){$ionicLoading.show();var len=stations.length;if(len>1){for(var startPoint=new AMap.LngLat(stations[0].stalongitude,stations[0].stalatitude),endPoint=new AMap.LngLat(stations[len-1].stalongitude,stations[len-1].stalatitude),waypoints=[],i=1;len-1>i;i++)waypoints.push(new AMap.LngLat(stations[i].stalongitude,stations[i].stalatitude));drving.search(startPoint,endPoint,{waypoints:waypoints},function(){$ionicLoading.hide(),map.setFitView()})}else alert("读取线路数据出错")}};$ionicLoading.show(),$myHttpService.post("api/busline/queryCycleBusScheduleInfo",{bsid:$scope.stopStationobj.bsid},function(data){$scope.busSchedule=data.busSchedule,$scope.busStations=data.busStations,console.log($scope.busStations),map=new AMap.Map("J_map_canvas",{zoom:14,animateEnable:!1,center:[114.530266,30.498785]}),AMap.plugin(["AMap.ToolBar"],function(){map.addControl(new AMap.ToolBar({offset:new AMap.Pixel(10,150)}))}),drving=new AMap.Driving({map:map}),MapOperation.drivingSearch($scope.busStations)});var content="<div class='bus-image marker '></div>";$interval(function(){$myHttpService.postNoLoad("api/busline/queryCarLocation",{carid:$scope.busSchedule.carid},function(data){if(console.log(data),marker)marker.setPosition($scope.lnglat.split(","));else var marker=new AMap.Marker({map:map,position:[data.car.currlon,data.car.currlat],content:content,draggable:!1})})},1e4),$scope.baoming=function(){if(void 0==$rootScope.session.user.userInfo){var url=encodeURIComponent("/schedule/detail?bsid="+$scope.stopStationobj.bsid+"&mode=1");$location.url("/auth/login?url="+url)}else $myHttpService.post("api/userEnrollBusline/userEnrollBusline",{userid:$rootScope.session.user.userInfo.userid,phone:$rootScope.session.user.userInfo.phone,lineid:$scope.busSchedule.lineid,bsid:$scope.busSchedule.bsid},function(){$location.url("/signup_success?bsid="+$scope.stopStationobj.bsid)})},$scope.oldIndex=0,$scope.oldIndexs=0,$scope.expand=function(){$scope.expandStatus=!$scope.expandStatus,1==$scope.expandStatus?map.panBy(0,140):map.panBy(0,-140)},$scope.RideactiveStations=function(index){$scope.busStations[$scope.oldIndex].active=!1,$scope.busStations[index].active=!0,$scope.oldIndex=index,map.setZoom(18),map.setCenter([$scope.busStations[index].stalongitude,$scope.busStations[index].stalatitude]),map.panBy(0,140)},$scope.$watch("stopStationobj.startIndex",function(newstartIndex,oldstartIndex){($scope.stopStationobj.startIndex==$scope.stopStationobj.endIndex||$scope.stopStationobj.startIndex>$scope.stopStationobj.endIndex)&&($scope.stopStationobj.startIndex=oldstartIndex,$scope.init())}),$scope.$watch("stopStationobj.endIndex",function(newstartIndex,oldstartIndex){($scope.stopStationobj.startIndex==$scope.stopStationobj.endIndex||$scope.stopStationobj.startIndex>$scope.stopStationobj.endIndex)&&($scope.stopStationobj.endIndex=oldstartIndex,$scope.init())}),$scope.selectstartadd=function(){$scope.stopStationobj.stopstation[$scope.stopStationobj.startIndex];$scope.stopStationobj.startIndex>$scope.stopStationobj.endIndex?layer.msg("起始位置不能超过终点位置"):$scope.stopStationobj.startIndex==$scope.stopStationobj.endIndex&&layer.msg("选择的地点信息不能相同"),$scope.init()},$scope.selectendadd=function(){$scope.stopStationobj.stopstation[$scope.stopStationobj.endIndex],parseInt($scope.stopStationobj.endIndex)+1;$scope.stopStationobj.startIndex>$scope.stopStationobj.endIndex?layer.msg("终点位置不能早于起始位置"):$scope.stopStationobj.startIndex==$scope.stopStationobj.endIndex&&layer.msg("选择的地点信息不能相同"),$scope.init()},$scope.showLocation=function(item){var dest=item.stalongitude+","+item.stalatitude,destName=item.stationname;window.location.href="http://m.amap.com/navi/?start=&dest="+dest+"&destName="+destName+"&naviBy=bus&key=1a5cdec55ebac9dbd85652429f54d4d1"}});